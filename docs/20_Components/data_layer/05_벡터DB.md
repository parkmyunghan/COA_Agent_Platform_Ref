# 벡터 DB (FAISS)

## 1. 개요

- **역할**: 임베딩 벡터 저장 및 유사도 검색
- **위치**: Data Layer
- **라이브러리**: FAISS (Facebook AI Similarity Search)
- **다이어그램 표시**: "벡터 DB (FAISS) (3개 문서)"

벡터 DB는 임베딩 엔진이 생성한 벡터를 저장하고, 유사도 기반 검색을 제공합니다. RAG(Retrieval-Augmented Generation) 시스템의 핵심 구성 요소입니다.

---

## 2. 주요 기능

### 2.1 벡터 저장
- 임베딩 벡터를 인덱스에 저장
- 메타데이터와 함께 관리
- 영속성 지원 (파일 저장)

### 2.2 유사도 검색
- L2 거리 기반 검색
- Top-K 유사 문서 검색
- 빠른 검색 성능 (FAISS 최적화)

### 2.3 인덱스 관리
- 인덱스 구축 및 재구축
- 인덱스 저장 및 로드

---

## 3. 구현 상세

### 3.1 사용 위치
벡터 DB는 RAGManager를 통해 사용됩니다:

```python
# core_pipeline/rag_manager.py
class RAGManager:
    def build_index(self, chunks: List[Dict], use_faiss: bool = True):
        """FAISS 인덱스 구축"""
        if use_faiss and FAISS_AVAILABLE:
            embeddings = self.compute_embeddings(self.chunks)
            dimension = embeddings.shape[1]
            self.faiss_index = faiss.IndexFlatL2(dimension)
            self.faiss_index.add(embeddings.astype('float32'))
```

### 3.2 주요 메서드

#### `retrieve(query: str, top_k: int = 3) -> List[Dict]`
쿼리와 유사한 문서를 검색합니다.

```python
# 사용 예시
rag_manager = RAGManager(config)
rag_manager.build_index(chunks)

query = "위협 상황 침투"
results = rag_manager.retrieve(query, top_k=5)
# 결과: [{"text": "...", "score": 0.95, ...}, ...]
```

---

## 4. 데이터 흐름

```
임베딩 엔진 (rogel-embedding-v2)
    ↓
벡터 생성 (1024차원)
    ↓
FAISS 인덱스 구축
    ├─→ IndexFlatL2 생성
    └─→ 벡터 추가
    ↓
인덱스 저장 (선택적)
    ↓
검색 요청
    ↓
FAISS 검색
    ↓
유사 문서 반환
```

---

## 5. 설정 및 파라미터

### 5.1 설정 파일
- **위치**: `config/model_config.yaml`
- **설정**:
  ```yaml
  embedding:
    index_path: "./knowledge/embeddings/faiss_index.bin"
  ```

### 5.2 인덱스 타입
- **IndexFlatL2**: L2 거리 기반 평면 인덱스
- **장점**: 정확한 검색
- **단점**: 대용량 데이터에서 느릴 수 있음

---

## 6. 사용 예시

### 6.1 인덱스 구축
```python
from core_pipeline.rag_manager import RAGManager

# 초기화
config = {"embedding_path": "./knowledge/embeddings"}
rag_manager = RAGManager(config)

# 문서 청킹
chunks = rag_manager.chunk_documents(documents)

# 인덱스 구축
rag_manager.build_index(chunks, use_faiss=True)
```

### 6.2 검색
```python
# 쿼리 검색
query = "위협 상황 침투"
results = rag_manager.retrieve(query, top_k=5)

for result in results:
    print(f"점수: {result['score']:.3f}")
    print(f"내용: {result['text'][:100]}...")
```

### 6.3 Agent에서 사용
```python
# agents/defense_coa_agent/logic_defense_enhanced.py
rag_results = self.core.rag_manager.retrieve_with_context(
    query=situation_text,
    top_k=5
)
```

---

## 7. 관련 컴포넌트

### 7.1 입력
- **임베딩 엔진**: 벡터 생성
- **RAGManager**: 인덱스 구축 및 관리

### 7.2 출력
- **Agent**: 유사 상황 검색 결과 제공
- **COAScorer**: 과거 사례 점수 계산에 사용

---

## 8. 참고 자료

- **코드 위치**: `core_pipeline/rag_manager.py`
- **FAISS 문서**: https://github.com/facebookresearch/faiss
- **관련 문서**: 
  - `docs/components/data_layer/03_임베딩엔진.md`
  - `docs/방책추천_시스템.md`

---

## 9. 중요 사항

### 9.1 검색 성능
FAISS는 대용량 벡터 검색에 최적화되어 있어 수천 개의 문서를 빠르게 검색할 수 있습니다.

### 9.2 메타데이터
각 벡터는 원본 텍스트와 메타데이터와 함께 저장되어 검색 결과에 포함됩니다.

---

**작성일**: 2025년 12월  
**버전**: 1.0

