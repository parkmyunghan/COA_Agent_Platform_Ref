# 데이터관리자 (Data Manager)

## 1. 개요

- **역할**: Excel 파일 로드 및 데이터 관리
- **위치**: Data Layer
- **클래스**: `core_pipeline.data_manager.DataManager`
- **다이어그램 표시**: "데이터관리자 (Data Manager)"

데이터관리자는 시스템의 원천 데이터를 관리하는 핵심 컴포넌트입니다. Excel 파일을 로드하고, 테이블정의서를 기반으로 데이터를 검증하며, 다른 컴포넌트에 데이터를 제공합니다.

---

## 2. 주요 기능

### 2.1 데이터 로드
- **`load_table(table_name)`**: 특정 테이블 로드
- **`load_all()`**: 모든 Excel 파일 로드
- **로더 기반 구조**: 테이블별 특수 로더 지원

### 2.2 데이터 검증
- 테이블정의서 기반 자동 검증
- 스키마 검증 및 데이터 타입 확인
- 필수 컬럼 존재 여부 확인

### 2.3 캐싱 및 변경 감지
- 파일 변경 시간 추적
- 자동 재로드 지원
- 메모리 효율적인 캐싱

---

## 3. 구현 상세

### 3.1 클래스 위치
```python
# core_pipeline/data_manager.py
class DataManager:
    """데이터 관리자 클래스 (로더 기반 구조 지원)"""
```

### 3.2 주요 메서드

#### `load_table(table_name: str) -> pd.DataFrame`
특정 테이블을 로드합니다.

```python
# 사용 예시
data_manager = DataManager(config)
df = data_manager.load_table("위협상황")
```

#### `load_all() -> Dict[str, pd.DataFrame]`
모든 Excel 파일을 로드합니다.

```python
# 사용 예시
all_data = data_manager.load_all()
# 결과: {"위협상황": DataFrame, "COA_Library": DataFrame, ...}
```

### 3.3 로더 시스템
특수 로직이 필요한 테이블은 전용 로더를 사용합니다:

```python
OPTIONAL_LOADER_MAP = {
    'COA_Library': 'COATemplateLoader',
    '전장축선': 'AxisLoader',
}
```

---

## 4. 데이터 흐름

```
Excel 파일 (data_lake/*.xlsx)
    ↓
DataManager.load_table()
    ↓
로더 선택 (GenericDataLoader 또는 특수 로더)
    ↓
테이블정의서 검증
    ↓
DataFrame 반환
    ↓
다른 컴포넌트에 제공
    ├─→ OntologyManager (온톨로지 변환)
    └─→ Agent (상황 정보 로드)
```

---

## 5. 설정 및 파라미터

### 5.1 설정 파일
- **위치**: `config/config.yaml`
- **주요 설정**:
  ```yaml
  data_paths:
    data_lake_path: "./data_lake"
    metadata_path: "./metadata"
  ```

### 5.2 지원하는 데이터 파일
총 16개의 핵심 전술 데이터 테이블을 관리합니다:

**[공통 및 시나리오]**
1. `시나리오모음.xlsx`: 위협-임무 연동 통합 시나리오
2. `평가기준_가중치.xlsx`: 방책 평가 항목별 수치 가중치
3. `제약조건.xlsx`: 작전 수행 시 고려해야 할 제한 사항

**[임무 및 위협]**
4. `임무정보.xlsx`: 상급 부대 지침 및 임무 상세
5. `위협상황.xlsx`: 식별된 적 위협 이벤트 정보
6. `위협유형_마스터.xlsx`: 위협 코드별 정의 및 심도 지표
7. `방책유형_위협유형_관련성.xlsx`: 교리적 대응 타당성 매트릭스

**[부대 및 자산]**
8. `아군부대현황.xlsx`: 아군 부대의 위치 및 기본 제대 정보
9. `아군가용자산.xlsx`: 실제 투입 가능한 세부 장비 및 자산
10. `적군부대현황.xlsx`: 식별된 적 부대의 위치 및 위협 수준
11. `임무별_자원할당.xlsx`: 특정 임무에 지정된 자산 목록

**[환경 및 지리]**
12. `전장축선.xlsx`: 주요 기동로 및 작전 축선 정의
13. `지형셀.xlsx`: 지형별 기동성, 방어유리도 등 물리 속성
14. `기상정보.xlsx`: 기상 상황 데이터 (METT-C 'W')
15. `민간시설.xlsx`: 민간인 밀집 지역 및 보호 대상 (METT-C 'C')

**[방책 라이브러리]**
16. `COA_Library.xlsx`: 표준 전술 방책 템플릿 및 필요 자원

---

## 6. 사용 예시

### 6.1 기본 사용
```python
from core_pipeline.data_manager import DataManager

# 초기화
config = {"data_lake_path": "./data_lake"}
data_manager = DataManager(config)

# 특정 테이블 로드
threat_df = data_manager.load_table("위협상황")
print(f"위협상황: {len(threat_df)}개 행")

# 모든 테이블 로드
all_data = data_manager.load_all()
print(f"총 {len(all_data)}개 테이블 로드됨")
```

### 6.2 Agent에서 사용
```python
# agents/defense_coa_agent/logic_defense_enhanced.py
situation_info = self.core.data_manager.load_table("위협상황")
```

---

## 7. 관련 컴포넌트

### 7.1 입력
- **Excel 파일**: `data_lake/` 폴더의 Excel 파일들
- **테이블정의서**: Excel 파일의 두 번째 시트

### 7.2 출력
- **OntologyManager**: 온톨로지 그래프 구축을 위한 데이터 제공
- **Agent**: 상황 정보 및 방책 라이브러리 제공
- **RAGManager**: 문서 데이터 제공 (선택적)

---

## 8. 참고 자료

- **코드 위치**: `core_pipeline/data_manager.py`
- **로더 구현**: `core_pipeline/data_loaders/`
- **관련 문서**: 
  - `docs/테이블정의서_구조_가이드.md`
  - `docs/테이블정의서_작성_예시.md`
- **설정 파일**: `config/config.yaml`

---

**작성일**: 2025년 12월  
**버전**: 1.0

