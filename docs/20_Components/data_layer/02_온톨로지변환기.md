# 온톨로지 변환기 (EnhancedOntologyManager)

## 1. 개요

- **역할**: Excel 데이터를 RDF 그래프로 변환 및 SPARQL 쿼리 실행
- **위치**: Data Layer
- **클래스**: `core_pipeline.ontology_manager_enhanced.EnhancedOntologyManager`
- **다이어그램 표시**: "온톨로지 변환기"

온톨로지 변환기는 Excel 데이터를 RDF(Resource Description Framework) 형식의 지식 그래프로 변환하고, SPARQL 쿼리를 통해 지식을 추론하는 핵심 컴포넌트입니다.

---

## 2. 주요 기능

### 2.1 온톨로지 그래프 구축
- **`build_from_data()`**: Excel 데이터프레임으로부터 RDF 그래프 생성
- **`generate_owl_ontology()`**: OWL 온톨로지 스키마 생성
- **`generate_instances()`**: 인스턴스 데이터 생성

### 2.2 SPARQL 쿼리
- **`query()`**: SPARQL 쿼리 문자열 직접 실행
- **`execute_template_query()`**: 템플릿 기반 쿼리 실행
- **`run_sparql()`**: 파일 기반 쿼리 실행

### 3.3 그래프 관리
- **`load_graph()`**: 저장된 그래프 로드
- **`save_graph()`**: 그래프를 파일로 저장
- **캐싱**: 데이터 변경 감지 및 자동 재구축

---

## 3. 구현 상세

### 3.1 클래스 위치
```python
# core_pipeline/ontology_manager_enhanced.py
class EnhancedOntologyManager:
    """강화된 온톨로지 관리자 (현재 시스템 로직 통합)"""
```

### 3.2 주요 메서드

#### `build_from_data(data: Dict[str, pd.DataFrame]) -> Graph`
Excel 데이터로부터 RDF 그래프를 구축합니다.

```python
# 사용 예시
data = data_manager.load_all()
graph = ontology_manager.build_from_data(data)
triples_count = len(list(graph.triples((None, None, None))))
print(f"그래프 구축 완료: {triples_count}개 triples")
```

#### `query(query_string: str, return_format: str = 'list') -> List[Dict]`
SPARQL 쿼리를 실행합니다.

```python
# 사용 예시
query = """
PREFIX def: <http://defense-ai.kr/ontology#>
SELECT ?coa ?name WHERE {
    ?coa rdf:type def:DefenseCOA .
    ?coa rdfs:label ?name .
}
LIMIT 10
"""
results = ontology_manager.query(query, return_format='list')
```

---

## 4. 데이터 흐름

```
Excel 데이터 (DataManager)
    ↓
build_from_data()
    ├─→ generate_owl_ontology() (스키마 생성)
    └─→ generate_instances() (인스턴스 생성)
    ↓
save_graph() (2단계 구조)
    ├─→ schema.ttl (스키마만)
    └─→ instances.ttl (인스턴스만)
    ↓
RDF Graph (RDFLib Graph 객체)
    ├─→ 메모리에 저장 (self.graph)
    └─→ 파일로 저장 (3단계 구조)
    ↓
SPARQL 쿼리
    ↓
추론 결과 반환
```

---

## 5. 설정 및 파라미터

### 5.1 설정 파일
- **위치**: `config/config.yaml`
- **주요 설정**:
  ```yaml
  ontology_path: "./knowledge/ontology"
  metadata_path: "./metadata"
  ```

### 5.2 네임스페이스
- **기본 네임스페이스**: `http://defense-ai.kr/ontology#`
- **레거시 네임스페이스**: `http://coa-agent-platform.org/ontology#` (호환성)

### 5.3 관계 매핑
한글 테이블명을 영문 관계명으로 매핑:
```python
RELATION_NAME_MAPPING = {
    "임무정보": "hasMission",
    "지형셀": "locatedIn",
    "전장축선": "hasAxis",
    "위협상황": "hasThreat",
    # ...
}
```

---

## 6. 사용 예시

### 6.1 기본 사용
```python
from core_pipeline.ontology_manager_enhanced import EnhancedOntologyManager
from core_pipeline.data_manager import DataManager

# 초기화
config = {"ontology_path": "./knowledge/ontology"}
data_manager = DataManager(config)
ontology_manager = EnhancedOntologyManager(config)
ontology_manager.data_manager = data_manager

# 그래프 구축
data = data_manager.load_all()
graph = ontology_manager.build_from_data(data)
```

### 6.2 SPARQL 쿼리
```python
# 방책 검색
query = """
PREFIX def: <http://defense-ai.kr/ontology#>
SELECT ?coa ?name WHERE {
    ?coa rdf:type def:DefenseCOA .
    ?coa rdfs:label ?name .
    FILTER(CONTAINS(?name, "방어"))
}
"""
results = ontology_manager.query(query)
```

### 6.3 Agent에서 사용
```python
# agents/defense_coa_agent/logic_defense_enhanced.py
graph = self.core.ontology_manager.graph
if graph is None:
    data = self.core.data_manager.load_all()
    graph = self.core.ontology_manager.build_from_data(data)
```

---

## 7. 관련 컴포넌트

### 7.1 입력
- **DataManager**: Excel 데이터 제공
- **메타데이터**: `metadata/ontology_config.xlsx` (스키마 정의)

### 7.2 출력
- **RDF Graph**: 다른 컴포넌트에 제공
  - Agent: SPARQL 쿼리를 통한 방책 검색
  - RelationshipChain: 관계 체인 탐색
  - COAScorer: 자원/환경 정보 조회

---

## 8. 참고 자료

- **코드 위치**: `core_pipeline/ontology_manager_enhanced.py`
- **관련 문서**: 
  - `docs/온톨로지_설계.md`
  - `docs/시스템_아키텍처.md`
- **설정 파일**: 
  - `config/config.yaml`
  - `metadata/ontology_config.xlsx`
- **SPARQL 템플릿**: `config/sparql_templates.yaml`

---

## 9. 중요 사항

### 9.1 자동 변환
Excel 데이터의 각 행이 RDF 삼중항(Triple)으로 자동 변환됩니다:
- 주체(Subject): 엔티티 URI
- 서술어(Predicate): 관계명
- 객체(Object): 값 또는 다른 엔티티 URI

### 9.2 캐싱
데이터가 변경되지 않으면 캐시된 그래프를 재사용하여 성능을 최적화합니다.

---

**작성일**: 2025년 12월  
**버전**: 1.0

