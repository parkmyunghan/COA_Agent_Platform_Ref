# 온톨로지 추론기 (SPARQL)

## 1. 개요

- **역할**: SPARQL 쿼리를 통한 지식 그래프 추론
- **위치**: Agent Layer
- **클래스**: `core_pipeline.reasoning_engine.ReasoningEngine`
- **다이어그램 표시**: "온톨로지 추론기 (SPARQL)"

온톨로지 추론기는 RDF 그래프에서 SPARQL 쿼리를 실행하여 관계를 탐색하고 추론합니다. Agent가 방책을 검색하거나 관계 체인을 탐색할 때 사용됩니다.

---

## 2. 주요 기능

### 2.1 SPARQL 쿼리 실행
- 직접 쿼리 문자열 실행
- 템플릿 기반 쿼리 실행
- 쿼리 결과를 리스트 또는 DataFrame으로 반환

### 2.2 관계 추출
- **`_extract_resource_availability()`**: 자원 가용성 추출
- **`_extract_environment_fit()`**: 환경 적합성 추출
- **`run_coa_rules()`**: COA 추천 규칙 실행

### 2.3 추론 규칙 실행
- YAML 기반 규칙 실행
- 그래프 기반 추론

---

## 3. 구현 상세

### 3.1 클래스 위치
```python
# core_pipeline/reasoning_engine.py
class ReasoningEngine:
    """추론 엔진 클래스"""
```

### 3.2 주요 메서드

#### `_extract_resource_availability(context: Dict) -> float`
자원 가용성을 추출합니다.

```python
# 사용 예시
reasoning_engine = ReasoningEngine(config)
resource_availability = reasoning_engine._extract_resource_availability({
    "ontology_manager": ontology_manager,
    "situation_id": "THR001",
    "coa_uri": "COA_DEF_001"
})
```

#### `_extract_environment_fit(context: Dict) -> float`
환경 적합성을 추출합니다.

```python
# 사용 예시
environment_fit = reasoning_engine._extract_environment_fit({
    "ontology_manager": ontology_manager,
    "situation_id": "THR001",
    "coa_uri": "COA_DEF_001"
})
```

---

## 4. 데이터 흐름

```
Agent 요청
    ↓
ReasoningEngine
    ├─→ OntologyManager.query() (SPARQL 실행)
    └─→ 템플릿 쿼리 실행
    ↓
RDF Graph에서 추론
    ↓
결과 반환
    ├─→ 자원 가용성
    ├─→ 환경 적합성
    └─→ 관계 체인
    ↓
Agent (점수 계산에 사용)
```

---

## 5. 설정 및 파라미터

### 5.1 SPARQL 템플릿
- **위치**: `config/sparql_templates.yaml`
- **템플릿 예시**:
  ```yaml
  find_required_resources: |
    PREFIX ns1: <http://defense-ai.kr/ontology#>
    SELECT ?resource WHERE {
      ?coa_uri ns1:requiresResource ?resource .
    }
  ```

### 5.2 추론 규칙
- **위치**: `knowledge/ontology/reasoning_rules.sparql`
- **형식**: SPARQL 쿼리

---

## 6. 사용 예시

### 6.1 직접 쿼리 실행
```python
from core_pipeline.ontology_manager_enhanced import EnhancedOntologyManager

ontology_manager = EnhancedOntologyManager(config)
graph = ontology_manager.build_from_data(data)

# SPARQL 쿼리 실행
query = """
PREFIX def: <http://defense-ai.kr/ontology#>
SELECT ?coa ?name WHERE {
    ?coa rdf:type def:DefenseCOA .
    ?coa rdfs:label ?name .
}
LIMIT 10
"""
results = ontology_manager.query(query, return_format='list')
```

### 6.2 템플릿 쿼리 실행
```python
# 템플릿 기반 쿼리
results = ontology_manager.execute_template_query(
    "find_required_resources",
    coa_uri="COA_DEF_001",
    return_format='list'
)
```

### 6.3 Agent에서 사용
```python
# agents/defense_coa_agent/logic_defense_enhanced.py
from core_pipeline.reasoning_engine import ReasoningEngine

reasoning_engine = ReasoningEngine(self.core.config)
resource_availability = reasoning_engine._extract_resource_availability(context)
```

---

## 7. 관련 컴포넌트

### 7.1 입력
- **지식그래프**: RDF 그래프 데이터
- **Agent**: 추론 요청

### 7.2 출력
- **Agent**: 추론 결과 제공
- **COAScorer**: 자원/환경 점수 계산에 사용
- **RelationshipChain**: 관계 체인 탐색에 사용

---

## 8. 참고 자료

- **코드 위치**: 
  - `core_pipeline/reasoning_engine.py`
  - `core_pipeline/ontology_manager_enhanced.py`
- **관련 문서**: 
  - `docs/components/data_layer/02_온톨로지변환기.md`
  - `docs/components/data_layer/04_지식그래프.md`
- **설정 파일**: 
  - `config/sparql_templates.yaml`
- **SPARQL 표준**: https://www.w3.org/TR/sparql11-query/

---

## 9. 중요 사항

### 9.1 템플릿 기반 쿼리
자주 사용하는 쿼리는 템플릿으로 저장하여 재사용할 수 있습니다.

### 9.2 추론 능력
SPARQL을 통해 복잡한 관계 추론과 패턴 매칭이 가능합니다.

---

**작성일**: 2025년 12월  
**버전**: 1.0

