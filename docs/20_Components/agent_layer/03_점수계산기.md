# 점수 계산기 (COA Scorer)

## 1. 개요

- **역할**: 방책(COA)의 적합성을 7가지 요소로 종합 평가
- **위치**: Agent Layer
- **클래스**: `core_pipeline.coa_scorer.COA Scorer`
- **다이어그램 표시**: "점수 계산기 (COA Scorer) (7가지 요소)"

점수 계산기는 팔란티어 모드에서 각 방책의 적합성을 7가지 요소를 종합하여 평가합니다. MAUT(다속성 효용 이론) 방식을 사용하여 가중치를 적용한 종합 점수를 계산합니다.

---

## 2. 주요 기능

### 2.1 7가지 평가 요소
1. **위협 대응** (Threat): 위협 수준에 대한 대응 능력
2. **자원 효율** (Resources): 가용 자원 대비 소요 자원의 적절성
3. **자산 능력** (Assets): 아군 자산의 전투력 및 상태
4. **환경 적합** (Environment): 지형, 기상 등 작전 환경과의 부합도
5. **과거 사례** (Historical): 유사 상황에서의 과거 성공률
6. **연계 작전** (Chain): 다른 작전/방책과의 연계성
7. **임무 부합성** (Mission Alignment): 임무 타입과 방책 타입의 부합성

### 2.2 가중치 적용
- Excel 파일에서 가중치 로드 (`평가기준_가중치.xlsx`)
- 가중치 총합 1.0으로 정규화
- 방책 타입별 가중치 지원

### 2.3 점수 계산
- MAUT 방식: 각 요소 점수 × 가중치의 합
- 점수 범위: 0.0 ~ 1.0
- 상세 breakdown 제공

---

## 3. 구현 상세

### 3.1 클래스 위치
```python
# core_pipeline/coa_scorer.py
class COAScorer:
    """COA 종합 점수 계산기"""
```

### 3.2 주요 메서드

#### `calculate_score(context: Dict) -> Dict`
종합 점수를 계산합니다.

```python
# 사용 예시
scorer = COAScorer(weights=weights, data_manager=data_manager)

context = {
    "threat_level": 0.85,
    "resource_availability": 0.70,
    "defense_assets": [...],
    "environment_fit": 0.80,
    "rag_results": [...],
    "chain_info": {...},
    "mission_type": "공격",
    "coa_type": "offensive"
}

result = scorer.calculate_score(context)
# 결과: {
#     'total': 0.757,
#     'breakdown': {
#         'threat': 0.85,
#         'resources': 0.70,
#         ...
#     },
#     'reasoning': "..."
# }
```

---

## 4. 데이터 흐름

```
Agent (컨텍스트 제공)
    ↓
COAScorer.calculate_score()
    ├─→ _calculate_threat_score()
    ├─→ _calculate_resource_score()
    ├─→ _calculate_asset_score()
    ├─→ _calculate_environment_score()
    ├─→ _calculate_historical_score()
    ├─→ _calculate_chain_score()
    └─→ _calculate_mission_alignment_score()
    ↓
가중치 적용
    ↓
종합 점수 계산
    ↓
점수 breakdown 및 reasoning 반환
    ↓
Agent (정렬 및 추천)
```

---

## 5. 설정 및 파라미터

### 5.1 가중치 파일
- **위치**: `data_lake/평가기준_가중치.xlsx`
- **형식**:
  | 평가요소 | 가중치 | 설명 |
  |---------|--------|------|
  | threat | 0.20 | 위협 대응 |
  | resources | 0.15 | 자원 효율 |
  | assets | 0.12 | 자산 능력 |
  | environment | 0.12 | 환경 적합 |
  | historical | 0.12 | 과거 사례 |
  | chain | 0.09 | 연계 작전 |
  | mission_alignment | 0.20 | 임무 부합성 |

### 5.2 임무-방책 부합성 매트릭스
```python
MISSION_COA_ALIGNMENT = {
    "공격": {
        "offensive": 1.0,      # Perfect match
        "defense": 0.2,        # Mismatch penalty
        ...
    },
    "방어": {
        "defense": 1.0,
        "offensive": 0.2,
        ...
    }
}
```

---

## 6. 사용 예시

### 6.1 기본 사용
```python
from core_pipeline.coa_scorer import COAScorer

scorer = COAScorer(data_manager=data_manager)

context = {
    "threat_level": 0.85,
    "resource_availability": 0.70,
    "defense_assets": [{"firepower": 80, "morale": 75}],
    "environment_fit": 0.80,
    "rag_results": [...],
    "chain_info": {...},
    "mission_type": "공격",
    "coa_type": "offensive"
}

result = scorer.calculate_score(context)
print(f"총점: {result['total']:.3f}")
print(f"Breakdown: {result['breakdown']}")
```

### 6.2 Agent에서 사용
```python
# agents/defense_coa_agent/logic_defense_enhanced.py
scorer = COAScorer(
    weights=weights,
    data_manager=self.core.data_manager
)

score_result = scorer.calculate_score(context)
strategy['total_score'] = score_result['total']
strategy['score_breakdown'] = score_result['breakdown']
```

---

## 7. 관련 컴포넌트

### 7.1 입력
- **Agent**: 컨텍스트 정보 제공
- **온톨로지 그래프**: 자원/환경 정보 조회
- **벡터 DB**: 과거 사례 검색 결과

### 7.2 출력
- **Agent**: 점수 및 breakdown 제공

---

## 8. 참고 자료

- **코드 위치**: `core_pipeline/coa_scorer.py`
- **관련 문서**: 
  - `docs/점수_산정_시스템.md`
  - `docs/방책추천_시스템.md`
- **설정 파일**: 
  - `data_lake/평가기준_가중치.xlsx`

---

## 9. 중요 사항

### 9.1 7가지 요소
기존 6가지 요소에 **임무 부합성(Mission Alignment)**이 추가되어 총 7가지 요소를 평가합니다.

### 9.2 가중치 동적 로드
Excel 파일에서 가중치를 로드하므로, 가중치 조정 시 Excel 파일만 수정하면 됩니다.

---

**작성일**: 2025년 12월  
**버전**: 1.0

