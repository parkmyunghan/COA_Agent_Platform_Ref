# 전략 체인 시각화 (Graphviz)

## 1. 개요

- **역할**: 위협(Threat)에서 방책(COA)까지의 관계 경로를 Graphviz로 시각화
- **위치**: Command Layer
- **클래스**: `ui.components.chain_visualizer.ChainVisualizer`
- **다이어그램 표시**: "전략 체인 시각화 (Graphviz)"

전략 체인 시각화는 온톨로지 그래프에서 발견된 관계 체인을 시각적으로 표현하여, 왜 특정 방책이 추천되었는지의 논리적 경로를 보여줍니다. 이는 "Palantir 방식"의 시각적 추론(Visual Reasoning)을 구현한 기능입니다.

---

## 2. 주요 기능

### 2.1 관계 체인 탐색
- 온톨로지 그래프에서 위협 → 자산 → 위치 → 방책 같은 다단계 관계 경로 탐색
- BFS 알고리즘 기반 체인 발견
- 최대 깊이 및 경로 수 제한

### 2.2 Graphviz 시각화
- 위협 노드: 빨간색 이중 원
- 방책 노드: 파란색 박스
- 중간 노드: 회색 박스
- 화살표: 관계(predicate) 표시

### 2.3 메트릭 표시
- 총 체인 수
- 평균 깊이
- 평균 점수

---

## 3. 구현 상세

### 3.1 클래스 위치
```python
# ui/components/chain_visualizer.py
class ChainVisualizer:
    """
    Dynamic Chain of Strategy Visualizer
    Renders relationship chains from Threat to COA using Graphviz
    """
```

### 3.2 주요 메서드

#### `render_chains(chain_info: Dict, expanded: bool = True)`
체인 정보를 Graphviz로 렌더링합니다.

```python
# 사용 예시
from ui.components.chain_visualizer import ChainVisualizer

visualizer = ChainVisualizer()
visualizer.render_chains(chain_info)
```

### 3.3 체인 정보 구조
```python
chain_info = {
    "chains": [
        {
            "path": [threat_uri, asset_uri, location_uri, coa_uri],
            "predicates": ["hasThreat", "locatedIn", "countersThreat"],
            "score": 0.85,
            "depth": 3
        },
        # ...
    ],
    "summary": {
        "total_chains": 5,
        "avg_depth": 2.8,
        "avg_score": 0.82
    }
}
```

---

## 4. 데이터 흐름

```
온톨로지 추론기 (ReasoningEngine)
    ↓
RelationshipChain.find_coa_chains()
    ↓
BFS 알고리즘으로 경로 탐색
    ↓
체인 정보 생성
    ↓
ChainVisualizer.render_chains()
    ↓
Graphviz DOT 코드 생성
    ↓
Streamlit Graphviz Chart 렌더링
    ↓
사용자에게 시각화 표시
```

---

## 5. 설정 및 파라미터

### 5.1 RelationshipChain 설정
```python
# core_pipeline/relationship_chain.py
config = {
    "max_chain_depth": 3,  # 최대 탐색 깊이
    "max_paths": 10        # 최대 경로 수
}
```

### 5.2 Graphviz 스타일
```python
# 노드 스타일
- 위협: 빨간색 이중 원 (doublecircle)
- 방책: 파란색 박스 (box)
- 중간: 회색 박스 (box, rounded)
```

---

## 6. 사용 예시

### 6.1 Agent에서 체인 계산
```python
# agents/defense_coa_agent/logic_defense_enhanced.py
chain_info = self._calculate_chain_info(strategy, situation_info)
```

### 6.2 Frontend(React)에서 시각화
```tsx
// frontend/src/components/ChainVisualizer.tsx
import { Graphviz } from 'graphviz-react';

export const ChainVisualizer = ({ dotGraph }) => {
    return (
        <div className="chain-viz-container">
            <Graphviz dot={dotGraph} options={{ zoom: true }} />
        </div>
    );
};
```

### 6.3 시각화 결과 예시
```
🔗 전략 연결 체인 (Dynamic Chain of Strategy) - 5 paths found

[메트릭]
Total Chains: 5
Avg Depth: 2.8
Avg Score: 0.82

[Graphviz 다이어그램]
위협(빨간색) → 자산(회색) → 위치(회색) → 방책(파란색)
```

---

## 7. 관련 컴포넌트

### 7.1 입력
- **온톨로지 추론기**: 관계 체인 탐색 결과
- **방책 결과 시각화**: 체인 정보 포함된 추천 결과

### 7.2 출력
- **사용자 인터페이스**: React Graphviz Component
- **사용자 피드백**: 체인 정보를 통한 추천 근거 이해

### 7.3 의존성
- **RelationshipChain**: `core_pipeline/relationship_chain.py`
- **Graphviz**: `graphviz-react` (Frontend Library)
- **온톨로지 그래프**: RDF 그래프 데이터

---

## 8. 참고 자료

- **코드 위치**: 
  - `frontend/src/components/ChainVisualizer.tsx`
  - `core_pipeline/relationship_chain.py`
- **관련 문서**: 
  - `docs/시스템_아키텍처.md`
  - `docs/방책추천_시스템.md`
- **Graphviz 문서**: https://graphviz.org/

---

## 9. 목적 및 효과

### 9.1 추천 근거 제공
- 단순히 점수만 제시하는 것이 아니라, 관계 경로를 통해 **왜** 해당 방책이 추천되었는지 설명

### 9.2 투명성 향상
- 추론 과정을 시각적으로 확인 가능
- 지휘관이 추천 근거를 이해하고 판단 가능

### 9.3 의사결정 지원
- 관계 체인을 통해 방책의 논리적 연결 확인
- 신뢰성 있는 의사결정 지원

---

**작성일**: 2026년 1월
**최종 업데이트**: 2026-01-26
**버전**: 2.0 (React Re-platforming)

