# 테이블정의서 구조 가이드

데이터 품질 검사 및 온톨로지 생성 시스템이 자동으로 인식할 수 있는 표준 테이블정의서 구조입니다.

## 기본 구조

테이블정의서는 엑셀 파일의 **두 번째 시트**에 위치하며, 시트명은 다음 중 하나여야 합니다:
- `테이블정의서` (권장)
- `정의서`
- `Schema` (영문)

## 필수 컬럼

| 컬럼명 | 설명 | 필수 여부 | 예시 |
|--------|------|-----------|------|
| **필드명** | 컬럼의 한글 이름 (실제 데이터 테이블의 컬럼명과 일치) | ✅ 필수 | `아군부대ID` |
| **타입** | 데이터 타입 | ✅ 필수 | `string`, `int`, `datetime`, `text` |
| **설명** | 컬럼 설명 및 제약조건 | ⚠️ 권장 | `PK, FRU001` |
| **FK** | 외래키 여부 (Y/N) | 선택 | `Y`, `N` |
| **관계** | 외래키(FK) 관계 정보 | 선택 | `전장축선:축선ID` |

**참고**: 컬럼명은 다음 중 하나로 인식됩니다:
- 필드명: `필드명`, `Field`, `컬럼`, `Column` (필드, field, 컬럼 포함)
- 타입: `타입`, `Type`, `데이터타입` (타입, type 포함)
- 설명: `설명`, `Description`, `Desc` (설명, description, desc 포함)
- FK: `FK`, `fk` (정확히 FK 또는 fk)
- 관계: `관계`, `Relation` (관계, relation 포함)

## 컬럼별 상세 설명

### 1. 필드명 (필수)
- 실제 데이터 테이블의 컬럼명과 **정확히 일치**해야 합니다
- 한글 또는 영문 모두 가능
- 예: `아군부대ID`, `부대명`, `전투력지수`

### 2. 타입 (필수)
- 데이터 타입을 명시합니다
- 지원 타입:
  - `string` 또는 `str`: 문자열
  - `int` 또는 `integer`: 정수
  - `float` 또는 `number`: 실수
  - `datetime` 또는 `date`: 날짜/시간
  - `text`: 긴 텍스트

### 3. 설명 (권장)
다음 정보를 포함할 수 있습니다:

#### Primary Key (PK) 표시
- 형식: `PK` 또는 `PK, [값]`
- 예: `PK`, `PK, FRU001`
- PK로 지정된 컬럼은 자동으로 필수 컬럼으로 인식됩니다

#### 값 범위
- 형식: `[최소값]~[최대값]` 또는 `[최소값]-[최대값]`
- 예: `0~100`, `1-5`
- 숫자 타입 컬럼의 유효 범위를 지정합니다

#### 열거형 값 (Enum)
- 형식: `값1/값2/값3` (슬래시로 구분)
- 예: `가용/손실/이동중`, `High/Medium/Low`, `사단/여단`
- 허용되는 값 목록을 지정합니다

#### 필수 여부
- 형식: `필수` 또는 `NOT NULL`
- NULL 값을 허용하지 않는 컬럼을 표시합니다

#### 기타 설명
- 컬럼의 용도나 추가 설명을 자유롭게 작성할 수 있습니다

### 4. FK (선택)
- 외래키 여부를 표시합니다
- **형식**: `Y`, `YES`, `TRUE`, `1`, `예`, `O` 중 하나
- FK 컬럼에 Y 값이 있으면 해당 필드가 외래키로 인식됩니다
- FK가 Y인 경우, **관계 컬럼에 관계 정보를 반드시 작성**해야 합니다

### 5. 관계 (선택)
- 외래키(FK) 관계를 명시합니다
- **FK 컬럼이 Y인 경우에만 사용**됩니다
- **형식**: `[참조테이블명]:[참조컬럼명]` 또는 `[참조테이블명].[참조컬럼명]`
- **실제 사용 형식 (권장)**: `전장축선:축선ID` (콜론 구분)
- 예:
  - `전장축선:축선ID` ✅ (권장)
  - `지형셀:지형셀ID` ✅ (권장)
  - `전장축선.축선ID` ✅ (점 구분도 지원)
  - `FK→전장축선.축선ID` ✅ (FK→ 접두사도 지원하지만 제거됨)

## 예시: 아군부대현황 테이블정의서

| 필드명 | 타입 | 설명 | FK | 관계 |
|--------|------|------|----|----|
| 아군부대ID | string | PK, FRU001 | N | - |
| 부대명 | string | 부대의 공식 명칭 | N | - |
| 제대 | string | 사단/여단 | N | - |
| 병종 | string | 보병/기계화/기갑 | N | - |
| 전투력지수 | int | 0~100 | N | - |
| 배치축선ID | string | 현재/계획 배치 축선 | Y | 전장축선:축선ID |
| 배치지형셀ID | string | 실제 위치 지형셀 | Y | 지형셀:지형셀ID |
| 가용상태 | string | 가용/손실/이동중 | N | - |
| 임무역할 | string | 주공/조공/예비 | N | - |
| 비고 | string | 추가 설명 | N | - |

## 예시: 위협상황 테이블정의서

| 필드명 | 타입 | 설명 | FK | 관계 |
|--------|------|------|----|----|
| 위협ID | string | PK | N | - |
| 발생시각 | datetime | 위협 발생 시각 | N | - |
| 위협유형코드 | string | 침투/기습공격/포병준비/상륙/공중위협/기만징후 | N | - |
| 관련축선ID | string | 위협이 영향을 미치는 작전축선 | Y | 전장축선:축선ID |
| 발생위치셀ID | string | 위협 발생 지점의 지형셀 | Y | 지형셀:지형셀ID |
| 관련_적부대ID | string | 관측된/추정되는 적 부대 | Y | 적군부대현황:적군부대ID |
| 위협수준 | string | High/Medium/Low 또는 1~5 | N | - |
| 관련임무ID | string | 해당 위협이 연관된 임무 | Y | 임무정보:임무ID |
| 원시보고텍스트 | text | 상황보고(SITREP) 원문 | N | - |

## 작성 가이드라인

### ✅ 권장 사항

1. **일관성 유지**
   - 모든 테이블에서 동일한 컬럼 구조 사용
   - 필드명은 실제 데이터와 정확히 일치

2. **명확한 표기**
   - PK는 설명 컬럼에 `PK`로 표시
   - FK는 FK 컬럼에 `Y`로 표시하고, 관계 컬럼에 `테이블명:컬럼명` 형식으로 명시
   - 값 범위는 `0~100` 형식으로 표시
   - 열거형은 `/`로 구분

3. **완전한 정보 제공**
   - 모든 필수 컬럼에 타입 명시
   - FK가 Y인 경우, 관계 컬럼에 반드시 관계 정보 명시
   - 값 제약조건은 설명 컬럼에 명시

### ❌ 피해야 할 사항

1. **필드명 불일치**
   - 테이블정의서의 필드명과 실제 데이터 컬럼명이 다르면 검증 실패

2. **FK 관계 정보 누락**
   - FK 컬럼에 Y를 표시했지만 관계 컬럼이 비어있으면 관계가 생성되지 않음

3. **모호한 표기**
   - `PK?`, `FK?` 같은 불확실한 표기
   - 값 범위를 `0-100` 대신 `0 이상 100 이하`로 표기 (파싱 실패)

## FK 관계 작성 방법

### 올바른 방법 ✅

1. **FK 컬럼에 Y 표기**
2. **관계 컬럼에 `테이블명:컬럼명` 형식으로 작성**
   - 예: `전장축선:축선ID`
   - 예: `지형셀:지형셀ID`

### 잘못된 방법 ❌

1. FK 컬럼에 Y를 표시했지만 관계 컬럼이 비어있음
2. 관계 컬럼에 `FK→전장축선.축선ID` 형식으로 작성 (접두사는 제거되지만 콜론 구분 권장)
3. FK 컬럼 없이 관계 컬럼만 작성 (FK 컬럼이 없으면 인식되지 않음)

## 검증 항목 매핑

테이블정의서의 정보는 다음과 같이 검증 및 온톨로지 생성에 사용됩니다:

| 테이블정의서 정보 | 사용 용도 |
|------------------|----------|
| PK 표시 | Primary Key 고유성 및 NULL 검증 |
| FK 컬럼 (Y) + 관계 컬럼 | Foreign Key 참조 무결성 검증, 온톨로지 Property 생성 |
| 타입 | 데이터 타입 검증 |
| 값 범위 (0~100) | 값 범위 검증 |
| 열거형 (가용/손실/이동중) | 허용 값 검증 |
| 필수 표시 | NULL 허용 여부 검증 |

## 온톨로지 생성 시 자동 반영

테이블정의서에 정의된 FK 관계는 **온톨로지 생성 시 자동으로 반영**됩니다:

1. 테이블정의서에서 FK 정보 추출
2. `relation_mappings.json`과 통합
3. OWL Property로 자동 생성 (domain/range 설정)
4. 인스턴스 간 관계 자동 생성

**참고**: 테이블정의서를 수정한 후에는 **2단계: 온톨로지 생성** 페이지에서 "그래프 생성" 버튼을 클릭하여 변경 사항을 반영해야 합니다.

## 템플릿 구조

표준 템플릿을 사용하여 일관된 테이블정의서를 작성하세요.

```
| 필드명 | 타입 | 설명 | FK | 관계 |
|--------|------|------|----|----|
| [컬럼1] | [타입] | [설명, PK, 범위, 열거형 등] | Y/N | [FK 관계] |
| [컬럼2] | [타입] | [설명] | N | - |
```

## 문제 해결

### 테이블정의서를 읽지 못하는 경우

1. 시트명 확인: `테이블정의서`, `정의서`, `Schema` 중 하나인지 확인
2. 필드명 컬럼 확인: `필드명`, `Field`, `컬럼` 중 하나가 있는지 확인
3. 파일 경로 확인: `data_lake` 폴더에 올바른 위치에 있는지 확인

### FK 관계가 생성되지 않는 경우

1. FK 컬럼에 Y가 표시되어 있는지 확인
2. 관계 컬럼에 `테이블명:컬럼명` 형식으로 작성되어 있는지 확인
3. 참조 대상 테이블이 실제 데이터 파일로 존재하는지 확인
4. 온톨로지 재생성 후 로그에서 `[INFO] 테이블정의서에서 FK 발견` 메시지 확인

### 검증이 제대로 작동하지 않는 경우

1. 필드명이 실제 데이터 컬럼명과 일치하는지 확인
2. PK, FK 표기가 정확한 형식인지 확인
3. 값 범위, 열거형 표기가 정확한 형식인지 확인

## 추가 정보

더 자세한 정보는 다음 파일을 참조하세요:
- `core_pipeline/ontology_manager_enhanced.py`의 `_load_fk_from_schema()` 함수
- `ui/components/data_quality_checker.py`의 `load_table_schema()` 함수
