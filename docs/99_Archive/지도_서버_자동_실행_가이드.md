# 지도 서버 자동 실행 가이드

## ✅ 자동 실행됨

**별도로 지도 서버를 실행할 필요가 없습니다!**

`run_streamlit.py`가 자동으로 지도 서버를 백그라운드에서 실행합니다.

---

## 🔧 현재 구조

### 자동 실행되는 서버

**파일**: `tools/map_server_osm.py` (통합 지도 서버)

**기능**:
- ✅ GeoJSON 파일 서빙 (`/maps/{filename}`)
- ✅ MBTiles 벡터 타일 서빙 (`/tiles/{z}/{x}/{y}`)
- ✅ 정적 라이브러리 서빙 (`/static/lib/`)

**포트**: 8080

**실행 방식**: `run_streamlit.py`가 백그라운드에서 자동 실행

---

## 📋 실행 흐름

### 1. Streamlit 앱 실행

```powershell
python run_streamlit.py
```

### 2. 자동으로 실행되는 것들

1. **지도 서버 시작** (백그라운드)
   - `tools/map_server_osm.py` 실행
   - 포트 8080에서 실행
   - GeoJSON + MBTiles 서빙

2. **Streamlit 앱 시작**
   - 기본 포트: 8501
   - 지도 서버(8080)와 통신

### 3. 종료 시

- Streamlit 앱 종료 시 지도 서버도 자동 종료

---

## 🔍 서버 상태 확인

### 자동 실행 확인

`run_streamlit.py` 실행 시 다음 메시지가 표시됩니다:

```
>> [INFO] 오프라인 지도 서버 시작 중 (Port 8080)...
>> [INFO] 지도 서버 실행됨 (OpenStreetMap 기반)
```

### 수동 확인

브라우저에서 다음 URL 접속:
```
http://localhost:8080/
```

응답 예시:
```json
{
  "status": "ok",
  "message": "COA Agent Map Server (OSM + MBTiles) is running",
  "osm_available": true,
  "natural_earth_available": true,
  "static_lib_available": true,
  "mbtiles_available": true,
  "mbtiles_path": "C:\\POC\\COA_Agent_Platform\\data\\maps\\south-korea.mbtiles"
}
```

---

## ⚠️ 문제 해결

### 지도 서버가 시작되지 않는 경우

1. **포트 8080이 이미 사용 중인 경우**
   ```powershell
   # 포트 8080 사용 중인 프로세스 확인
   netstat -ano | findstr :8080
   ```
   
   해결 방법:
   - 다른 프로세스 종료
   - 또는 `tools/map_server_osm.py`에서 포트 변경

2. **MBTiles 파일이 없는 경우**
   - 서버는 정상 실행되지만 타일 서빙 불가
   - GeoJSON은 정상 작동
   - 기본 배경만 표시됨

3. **서버 로그 확인**
   - `run_streamlit.py` 실행 시 콘솔에 오류 메시지 표시
   - 예: `>> [WARN] 지도 서버 시작 실패: ...`

---

## 🎯 별도 실행이 필요한 경우

일반적으로는 **별도 실행이 필요 없습니다**.

다만, 다음 경우에는 수동 실행이 필요할 수 있습니다:

### 1. 지도 서버만 독립적으로 실행

```powershell
python tools/map_server_osm.py
```

### 2. 다른 포트에서 실행

`tools/map_server_osm.py` 파일 수정:
```python
uvicorn.run(app, host="0.0.0.0", port=8081)  # 포트 변경
```

그리고 `ontology_aware_cop.py`에서도 포트 변경:
```python
base_url = "http://localhost:8081"  # 포트 변경
```

---

## 📊 서버 엔드포인트

### 자동 실행되는 서버 (`tools/map_server_osm.py`)

| 엔드포인트 | 설명 |
|-----------|------|
| `GET /` | 헬스 체크 |
| `GET /maps/{filename}` | GeoJSON 파일 서빙 |
| `GET /maps/list` | 사용 가능한 GeoJSON 파일 목록 |
| `GET /tiles/{z}/{x}/{y}` | MBTiles 벡터 타일 서빙 |
| `GET /static/lib/{filename}` | 정적 라이브러리 (JS/CSS) |

---

## ✅ 결론

**별도로 지도 서버를 실행할 필요가 없습니다!**

`python run_streamlit.py`만 실행하면:
- ✅ 지도 서버 자동 시작
- ✅ Streamlit 앱 시작
- ✅ 모든 기능 정상 작동

종료 시에도 자동으로 정리됩니다.









