# 진행 상황 표시 개선 - 추가 업데이트

## 문제점 2차 발견
LLM 방책 선정사유 생성 단계(90-95%)에서 UI가 멈춘 것처럼 보이는 문제가 추가로 발견되었습니다.

### 원인 분석
- `execute_reasoning` 메서드의 630-669번 줄에서 각 방책마다 `_generate_recommendation_reason`을 호출
- 이 메서드가 LLM을 사용하여 선정사유를 생성하므로 시간이 오래 걸림 (방책당 2-5초)
- 이 과정에서 진행율 업데이트가 없어 UI가 응답하지 않는 것처럼 보임

### 해결책

#### 1. 선정사유 생성 루프에 진행율 추가 (`logic_defense_enhanced.py`)

##### Line 628-630: 진행율 초기화
```python
# [NEW] 선정사유 생성 시작 진행율 보고
self._report_status("방책 선정사유 및 상세 정보 생성 중...", progress=90)
```

##### Line 631-638: 각 방책 처리 시 진행율 업데이트
```python
for idx, s in enumerate(recommendations):
    # [NEW] 각 방책 처리 진행율 업데이트 (90-95% 범위)
    if len(recommendations) > 0:
        item_progress = 90 + int((idx / len(recommendations)) * 5)
        coa_name = s.get("명칭") or s.get("방책명") or s.get("name") or f"방책 {idx+1}"
        self._report_status(f"'{coa_name}' 선정사유 생성 중... ({idx+1}/{len(recommendations)})", progress=item_progress)
```

예시 출력:
```
[90%] 방책 선정사유 및 상세 정보 생성 중...
[90%] '방어진지 고수' 선정사유 생성 중... (1/3)
[92%] '기동방어' 선정사유 생성 중... (2/3)
[94%] '반격작전' 선정사유 생성 중... (3/3)
[95%] 방책 선정사유 생성 완료
```

#### 2. 중복 진행 상황 보고 제거

`_generate_recommendation_reason` 메서드 내부의 진행 상황 보고를 제거했습니다:
- **제거 전**: 메서드 시작 시(928-931라인), LLM 호출 전후(1040-1048라인)에 각각 보고
- **제거 후**: 외부 루프에서 이미 보고하므로 중복 제거

이로써 진행 상황이 더 명확하고 일관되게 표시됩니다.

## 개선 효과

### Before (이전)
```
[85%] LLM 기반 방책 구체화 수행 중...
[화면 어두워짐, 2-15초간 아무 반응 없음]  ← 사용자 혼란
[100%] 방책 분석 완료
```

### After (개선 후)
```
[85%] LLM 기반 방책 구체화 수행 중...
[90%] 방책 선정사유 및 상세 정보 생성 중...
[90%] '방어진지 고수' 선정사유 생성 중... (1/3)  ← 명확한 진행 상황
[92%] '기동방어' 선정사유 생성 중... (2/3)
[94%] '반격작전' 선정사유 생성 중... (3/3)
[95%] 방책 선정사유 생성 완료
[100%] 방책 분석 완료
```

## 변경된 파일

### 1. `agents/defense_coa_agent/logic_defense_enhanced.py`
- **Line 628-630**: 선정사유 생성 시작 진행율 보고 추가
- **Line 631-638**: 각 방책 처리 시 진행율 업데이트 추가
- **Line 669-671**: 선정사유 생성 완료 진행율 보고 추가
- **Line 928-931**: 중복 진행 상황 보고 제거 (REMOVED)
- **Line 1040-1048**: 중복 진행 상황 보고 제거 (REMOVED)

### 2. `ui/views/agent_execution.py` (이전 개선사항)
- Progress bar 및 진행율 텍스트 표시 추가
- CSS 스타일 개선

### 3. `docs/progress_indicator_improvement.md`
- 90-95% 선정사유 생성 단계 추가 문서화

## 테스트 방법

1. 브라우저 새로고침 (Streamlit 앱 재로드)
2. "지휘통제/분석" 페이지로 이동
3. 상황 정보 설정
4. "🎯 방책 추천 실행" 버튼 클릭
5. **90-95% 구간**에서 각 방책별 선정사유 생성 진행 상황 확인

## 성능 참고사항

- LLM을 사용하는 경우 방책당 2-5초 소요 가능
- 로컬 LLM: 더 오래 걸릴 수 있음 (5-10초/방책)
- 사내망 LLM/OpenAI: 네트워크 지연에 따라 가변적
- 3개 방책 기준 총 6-15초 정도 소요 예상

진행율 표시로 사용자는 시스템이 작동 중임을 명확히 인지할 수 있습니다.

## 추가 최적화 가능성 (향후)

1. **병렬 처리**: 여러 방책의 선정사유를 동시에 생성 (현재는 순차 처리)
2. **캐싱**: 동일한 방책에 대해 이전 선정사유 재사용
3. **타임아웃**: LLM 응답이 너무 오래 걸리면 fallback으로 전환
4. **백그라운드 처리**: 메인 결과를 먼저 표시하고 선정사유는 나중에 추가

현재 구현은 **확실한 진행 상황 피드백**에 초점을 맞추었습니다.
