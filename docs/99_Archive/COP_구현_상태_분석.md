# COP 구현 상태 상세 분석

## 📋 분석 개요

"COP 구성 재지시.md" 문서의 요구사항과 현재 구현(`ontology_aware_cop_leaflet.py`)을 비교 분석한 결과입니다.

---

## ✅ 완전히 구현된 항목

### 1. COP의 역할 재정의 ✅
- **요구사항**: "상황 표시 지도"가 아닌 "온톨로지 추론 결과를 공간적으로 검증하는 지휘 인터페이스"
- **구현 상태**: ✅ 완료
  - 컴포넌트 목적이 명확히 정의됨
  - 지도는 배경으로 사용, 핵심은 COA 판단과 설명
  - 파일명과 주석에 명시됨

### 2. 온톨로지 URI 포함 ✅
- **요구사항**: 모든 GeoJSON 객체는 반드시 온톨로지 URI를 포함해야 함
- **구현 상태**: ✅ 완료
  - `scenario_mapper.py`에서 `unit_uri`, `threat_uri`, `coa_uri` 추가
  - 팝업에서 URI 표시
  - `OntologyCOPMapper`에서 온톨로지 정보 조회

### 3. Unit(부대) 3계층 정보 ✅
- **요구사항**: 
  1) 정적 정보 (편제, 제대)
  2) 동적 상태 (임무, 가용성)
  3) 추론 연계 정보 (왜 특정 COA에 포함/배제되었는지)
- **구현 상태**: ✅ 완료
  - `scenario_mapper.py`에서 3계층 정보 포함
  - 팝업에서 3계층 정보 표시 (lines 478-511)
  - MIL-STD-2525D 부호 사용 (milsymbol.js)

### 4. UI 구조 (Palantir AIP 유사) ✅
- **요구사항**: 
  - 좌측: 현재 상황 요약
  - 우측: 선택된 COA의 추론 근거 및 온톨로지 경로
  - 하단: 시간 흐름/단계 전환
- **구현 상태**: ✅ 부분 완료
  - 좌측 패널: ✅ 구현됨 (lines 546-569)
  - 우측 패널: ✅ 구현됨 (lines 571-616)
  - 하단 패널: ✅ 구현됨 (COA 비교 모드, lines 618-636)
  - ⚠️ 시간 흐름/단계 전환: ❌ 미구현

### 5. COA 비교 모드 ✅
- **요구사항**: 복수 COA 비교 모드를 기본 기능으로 포함
- **구현 상태**: ✅ 완료
  - 하단 패널에 COA 카드 표시 (lines 619-636)
  - COA 선택 시 우측 패널에 추론 근거 표시
  - 선택된 COA 강조 표시

### 6. COA 집합 표현 ✅
- **요구사항**: COA는 다음의 집합으로 표현
  - 기동 경로
  - 참여 부대
  - 노출 위협
  - 성공 가능성/손실 추정
- **구현 상태**: ✅ 완료
  - `scenario_mapper.py`에서 `participating_units`, `exposed_threats`, `success_probability` 포함
  - 지도에 경로(LineString)와 부대(Point) 표시
  - 점수 표시 (우측 패널)

---

## ⚠️ 부분적으로 구현된 항목

### 1. 지도 데이터 구조 ⚠️
- **요구사항**: 
  - Base Map: 로컬 MBTiles (MapLibre GL JS 사용)
  - 전술 객체는 Base Map과 분리된 GeoJSON 레이어
- **구현 상태**: ⚠️ 부분 완료
  - ✅ GeoJSON 레이어 분리: 완료
  - ❌ MapLibre GL JS: 미사용 (Leaflet 사용 중)
  - ❌ MBTiles: 준비되어 있으나 사용하지 않음
  - 현재는 기본 배경(rectangle)만 사용 (lines 334-342)
  - `ontology_aware_cop.py` 파일에는 MapLibre 코드가 있으나 사용되지 않음

### 2. Threat(위협) 표현 ⚠️
- **요구사항**: 
  - 단순 반경 시각화 금지
  - 위협은 "개념 객체"로 표현
  - COA 선택 시 해당 COA에 영향을 주는 위협만 강조 표시
- **구현 상태**: ⚠️ 부분 완료
  - ✅ 개념 객체 속성: `threat_type`, `confidence`, `affected_coa` 포함
  - ✅ 위협 유형에 따라 다른 스타일 적용 (lines 418-428)
  - ❌ **여전히 반경 시각화 사용**: `L.circle` 사용 (lines 430-436)
  - ❌ COA 선택 시 위협 강조: 미구현

### 3. 추론 근거 표시 ⚠️
- **요구사항**: 우측 패널에 추론 근거 및 온톨로지 경로 표시
- **구현 상태**: ⚠️ 부분 완료
  - ✅ 추론 근거 텍스트 표시: 완료 (lines 581-588)
  - ✅ 점수 세부 표시: 완료 (lines 590-597)
  - ✅ 온톨로지 URI 표시: 완료 (lines 599-604)
  - ⚠️ 추론 경로: JSON 텍스트로만 표시 (lines 606-613)
  - ❌ 추론 경로 그래프 시각화: 미구현

---

## ❌ 미구현 항목

### 1. MapLibre GL JS + MBTiles ❌
- **요구사항**: Base Map은 로컬 MBTiles (MapLibre GL JS 사용)
- **현재 상태**: 
  - Leaflet.js 사용 중
  - MBTiles 파일은 준비되어 있음 (`south-korea.mbtiles`)
  - MBTiles 서버도 준비되어 있음 (`scripts/serve_offline_map.py`)
  - 하지만 COP 컴포넌트에서 사용하지 않음
  - `ontology_aware_cop.py` 파일에 MapLibre 코드가 있으나 사용되지 않음

### 2. Threat 단순 반경 금지 ❌
- **요구사항**: "단순 반경 시각화 금지"
- **현재 상태**: 
  - 여전히 `L.circle`을 사용하여 반경 시각화 (lines 430-436)
  - 주석에는 "단순 반경이 아닌 개념적 표현"이라고 되어 있으나 실제로는 반경 사용
  - 위협 유형에 따라 색상/투명도는 다르게 적용하지만, 여전히 원형 반경

### 3. COA 선택 시 위협 강조 ❌
- **요구사항**: "COA 선택 시 해당 COA에 실제로 영향을 주는 위협만 강조 표시"
- **현재 상태**: 
  - COA 선택 기능은 있음
  - 하지만 위협 강조 기능은 없음
  - `affected_coa` 속성은 있으나 활용하지 않음

### 4. 시간 흐름/단계 전환 ❌
- **요구사항**: 하단 패널에 "시간 흐름/단계 전환"
- **현재 상태**: 
  - 하단 패널은 COA 비교 모드로만 사용
  - 시간 흐름 슬라이더나 단계 전환 기능 없음

### 5. 추론 경로 그래프 시각화 ❌
- **요구사항**: 온톨로지 경로를 시각화
- **현재 상태**: 
  - JSON 텍스트로만 표시 (lines 606-613)
  - 그래프 형태의 시각화 없음

### 6. 애니메이션 (결과 설명 보조 수단) ❌
- **요구사항**: 애니메이션은 "결과 설명 보조 수단"으로만 사용
- **현재 상태**: 
  - 애니메이션 기능 자체가 없음
  - 구현 필요

---

## 📊 구현 완성도 요약

| 항목 | 완성도 | 상태 |
|------|--------|------|
| COP 역할 재정의 | 100% | ✅ 완료 |
| 온톨로지 URI 포함 | 100% | ✅ 완료 |
| Unit 3계층 정보 | 100% | ✅ 완료 |
| UI 구조 (기본) | 90% | ✅ 완료 (시간 흐름 제외) |
| COA 비교 모드 | 100% | ✅ 완료 |
| COA 집합 표현 | 100% | ✅ 완료 |
| MapLibre GL JS + MBTiles | 0% | ❌ 미구현 |
| Threat 개념 객체 (속성) | 100% | ✅ 완료 |
| Threat 반경 금지 | 0% | ❌ 여전히 반경 사용 |
| COA 선택 시 위협 강조 | 0% | ❌ 미구현 |
| 시간 흐름/단계 전환 | 0% | ❌ 미구현 |
| 추론 경로 그래프 시각화 | 20% | ⚠️ 텍스트만 |
| 애니메이션 | 0% | ❌ 미구현 |

**전체 완성도: 약 60%**

---

## 🔴 주요 문제점

### 1. Threat 반경 시각화 문제
**요구사항**: "단순 반경 시각화 금지"
**현재 구현**: `L.circle`을 사용하여 반경 시각화 (lines 430-436)

```javascript
// 현재 코드 (문제)
if (props.threat_radius) {
    L.circle(latlng, {
        radius: props.threat_radius,
        ...
    }).addTo(layerRefs.current.threatZones);
}
```

**해결 방안**:
- 반경 대신 위협 유형에 따른 아이콘/심볼 사용
- 또는 위협 영향 범위를 다각형(Polygon)으로 표현
- 또는 위협 유형별로 다른 시각적 표현 (예: 미사일은 화살표, 포병은 부채꼴)

### 2. MapLibre GL JS 미사용
**요구사항**: "Base Map: 로컬 MBTiles (MapLibre GL JS 사용)"
**현재 구현**: Leaflet.js 사용, 기본 배경만 표시

**해결 방안**:
- `ontology_aware_cop.py`의 MapLibre 코드를 활성화
- 또는 Leaflet에서 MBTiles를 래스터 타일로 사용
- 또는 현재 Leaflet + GeoJSON 방식 유지 (요구사항 재확인 필요)

### 3. COA 선택 시 위협 강조 미구현
**요구사항**: "COA 선택 시 해당 COA에 실제로 영향을 주는 위협만 강조 표시"
**현재 구현**: COA 선택 기능만 있고 위협 강조 없음

**해결 방안**:
- `affected_coa` 속성을 활용하여 필터링
- 선택된 COA의 `exposed_threats`와 매칭
- 강조 표시 로직 추가

---

## 💡 개선 권장 사항

### 우선순위 1: Threat 반경 제거
1. `L.circle` 제거
2. 위협 유형별 시각적 표현으로 대체
3. 예: 미사일 → 화살표 방향, 포병 → 부채꼴 범위

### 우선순위 2: COA 선택 시 위협 강조
1. `affected_coa` 속성 활용
2. 선택된 COA와 관련된 위협만 강조 표시
3. 나머지 위협은 반투명 처리

### 우선순위 3: MapLibre GL JS 전환 (선택)
1. MBTiles 벡터 타일 활용
2. 더 나은 성능과 스타일링
3. 또는 요구사항 재확인 (Leaflet 유지 가능 여부)

### 우선순위 4: 시간 흐름/단계 전환
1. 하단 패널에 타임라인 슬라이더 추가
2. 시간에 따른 상황 변화 표시

### 우선순위 5: 추론 경로 그래프 시각화
1. 우측 패널에 그래프 형태로 표시
2. 온톨로지 관계 시각화

---

## 📝 결론

현재 COP 구현은 **핵심 기능의 약 60%가 완료**되었습니다.

**잘 구현된 부분**:
- COP의 역할 재정의
- 온톨로지 URI 포함
- Unit 3계층 정보
- COA 비교 모드
- 기본 UI 구조

**개선이 필요한 부분**:
- Threat 반경 시각화 제거 (가장 중요)
- COA 선택 시 위협 강조
- MapLibre GL JS 전환 (요구사항 재확인 필요)
- 시간 흐름/단계 전환
- 추론 경로 그래프 시각화

**즉시 수정 필요**: Threat 반경 시각화를 제거하고 개념 객체 표현으로 대체해야 합니다.












