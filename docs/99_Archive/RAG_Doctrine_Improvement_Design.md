# RAG 기반 교리·교범 활용 개선 설계

## 문서 정보
- **작성일**: 2026-01-06
- **목적**: C4I 지휘결심 지원(방책 추천, COA Agent) 관점에서 RAG 중심 아키텍처 개선
- **참조 문서**: `docs/99_MD/20260106_01.md`

---

## 1. RAG로 처리하는 것이 적합한 요소

### 1.1 작전 교리 및 전술 운용 원칙
**현재 상태**: 
- RAG 문서로 일부 구현됨 (`knowledge/rag_docs/작전_방책선정_지침.txt`)
- 온톨로지에 교리 내용이 하드코딩되어 있지 않음 (양호)

**개선 방향**:
- ✅ **유지**: 교리·교범은 RAG로만 처리
- ✅ **확장**: RAG 문서 라이브러리 확대
  - 작전 교리 문서 추가
  - 전술 운용 원칙 문서 추가
  - 부대 운용 기준 문서 추가

**구현 위치**:
- `core_pipeline/rag_manager.py`: RAG 검색 기능 (이미 구현됨)
- `core_pipeline/coa_engine/llm_services.py::DoctrineSearchService`: 교범 검색 서비스 (이미 구현됨)

### 1.2 작전 절차 설명 (MDMP, 작전단계 등)
**현재 상태**:
- 온톨로지에 단계 정보가 일부 하드코딩됨 (`hasPhasingInfo` 속성)
- RAG로 충분히 대체 가능

**개선 방향**:
- ⚠️ **단계 정보 하드코딩 제거 검토**
  - `hasPhasingInfo`는 COA 인스턴스의 실행 단계 정보이므로 구조화 유지 필요
  - 단, **작전 절차 설명**은 RAG로 처리
- ✅ **RAG 문서 추가**: MDMP 절차, 작전단계 설명 문서

### 1.3 교범 내 서술형 판단 기준
**현재 상태**:
- `적용조건`, `전장환경_최적조건` 등이 온톨로지에 문자열로 저장됨
- 예: `"threat_level > 0.8 and resources < 0.5"`

**개선 방향**:
- ✅ **서술형 판단 기준 → RAG로 이동**
  - 온톨로지의 `적용조건` 필드는 간단한 키워드만 유지
  - 상세한 판단 기준은 RAG 문서로 처리
- ✅ **RAG 문서 생성**: "위협 수준별 방책 선정 기준", "자원 가용성 평가 기준" 등

### 1.4 지휘관 의도 (Commander's Intent) - 서술적 판단 기준
**현재 상태**:
- `Mission` 모델에 `commander_intent` 필드 존재 (서술형)
- 온톨로지에 구조화되지 않음 (양호)

**개선 방향**:
- ✅ **RAG로 처리**: 지휘관 의도 해석 및 판단 기준
- ✅ **RAG 문서 추가**: "지휘관 의도 해석 가이드", "위험 수용도 평가 기준"
- ⚠️ **구조화 필요**: COA 점수 가중치 조정 로직은 구조화 유지 (현재 `COAScorer`에 구현됨)

### 1.5 교리·규칙 기반 제약 - 설명·판단 근거
**현재 상태**:
- `제약조건` 테이블이 구조화되어 있음
- 제약 내용 설명은 서술형 (`제약내용` 필드)

**개선 방향**:
- ✅ **제약 설명 → RAG로 처리**
- ✅ **강제 제약 조건 → 구조화 유지** (OWL/Rule)
- ✅ **RAG 문서 추가**: "ROE 해석 가이드", "무기 운용 제한 기준"

### 1.6 지휘통제 구조 (C2 Relationship) - 규정 설명
**현재 상태**:
- OPCON/TACON/ADCON 개념이 온톨로지에 구조화되지 않음
- `PermissionManager`에 역할 기반 권한만 존재

**개선 방향**:
- ✅ **규정 설명 → RAG로 처리**
- ⚠️ **권한 여부 판단 → 구조화 필요** (향후 구현)
- ✅ **RAG 문서 추가**: "OPCON/TACON/ADCON 규정", "지휘통제 구조 설명"

### 1.7 인접·연합 부대 고려 - 개념 설명
**현재 상태**:
- 인접 축선 충돌, 화력 간섭 개념이 온톨로지에 구조화되지 않음

**개선 방향**:
- ✅ **개념 설명 → RAG로 처리**
- ⚠️ **공간·관계 판단 → 그래프 구조 필요** (향후 구현)
- ✅ **RAG 문서 추가**: "인접 부대 협조 기준", "화력 간섭 방지 원칙"

---

## 2. 구조화(Ontology/DB)가 반드시 필요한 요소

### 2.1 전장 데이터 (엔티티 및 관계)
**현재 상태**: ✅ 이미 구조화됨
- 부대, 위협상황, 지형셀, 전장축선, 임무정보 등
- Excel → 온톨로지 자동 변환

**유지 이유**:
- SPARQL 질의를 통한 관계 탐색 필요
- 그래프 기반 추론 필요

### 2.2 COA 라이브러리 (방책 인스턴스)
**현재 상태**: ✅ 이미 구조화됨
- COA ID, 명칭, 유형, 필요자원 등

**유지 이유**:
- 방책 검색 및 필터링 필요
- 방책 간 관계 추론 필요

### 2.3 METT-C 평가 요소
**현재 상태**: ✅ 이미 구조화됨
- Mission, Enemy, Terrain, Troops, Civilian, Time
- `METTCEvaluator`로 평가 로직 구조화

**유지 이유**:
- 정량적 점수 계산 필요
- 제약 조건 검증 필요

### 2.4 자원 가용성 및 환경 정보
**현재 상태**: ✅ 이미 구조화됨
- `아군가용자산` 테이블
- `기상상황` 테이블

**유지 이유**:
- 자원 매칭률 계산 필요
- 환경 적합성 평가 필요

### 2.5 제약조건 (강제 제약)
**현재 상태**: ✅ 이미 구조화됨
- `제약조건` 테이블
- `appliesTo` 관계

**유지 이유**:
- 제약 위반 COA 자동 배제 필요
- 제약 조건 검증 필요

### 2.6 COA 점수 가중치
**현재 상태**: ✅ 이미 구조화됨
- `평가기준_가중치.xlsx`
- `COAScorer`에서 적응형 가중치 계산

**유지 이유**:
- 정량적 점수 계산 필요
- 상황별 가중치 조정 필요

### 2.7 지휘관 의도 - COA 점수 가중치 조정
**현재 상태**: ✅ 부분 구현됨
- `COAScorer::_calculate_adaptive_weights`에서 위협 수준 기반 가중치 조정

**개선 방향**:
- ⚠️ **지휘관 의도 기반 가중치 조정 로직 추가**
  - 공세/방어/기동 중점 → 가중치 조정
  - 위험 수용도 → 가중치 조정
  - 주공·조공 구분 → 가중치 조정

### 2.8 지휘통제 구조 - 권한 여부 판단
**현재 상태**: ⚠️ 미구현
- `PermissionManager`는 UI 권한만 관리
- OPCON/TACON/ADCON 관계 미구현

**개선 방향**:
- ⚠️ **향후 구현**: 부대 간 지휘통제 관계 구조화
  - 온톨로지에 `hasOPCON`, `hasTACON`, `hasADCON` 관계 추가
  - 권한 검증 로직 추가

### 2.9 인접·연합 부대 고려 - 공간·관계 판단
**현재 상태**: ⚠️ 미구현
- 인접 축선 충돌 감지 미구현
- 화력 간섭 감지 미구현

**개선 방향**:
- ⚠️ **향후 구현**: 공간 관계 기반 충돌 감지
  - 지형셀 기반 인접성 계산
  - 화력 사거리 기반 간섭 감지

---

## 3. 현재 중복 구현된 요소 (삭제/통합 대상)

### 3.1 COA 적용조건 하드코딩
**현재 상태**: ⚠️ 중복
- 온톨로지 인스턴스에 `적용조건` 필드 (expression 타입)
- 예: `"enemy_momentum < 0.5"`, `"penetration == True"`, `"threat_level > 0.8 and resources < 0.5"`

**개선 방향**:
- ✅ **단순화**: `적용조건` 필드를 키워드 리스트로 변경
  - 예: `["고위협", "자원부족"]` 또는 `["침투", "기동"]`
- ✅ **상세 기준 → RAG로 이동**: 판단 기준 설명은 RAG 문서로 처리
- ✅ **RAG 문서 추가**: "COA 적용조건 해석 가이드", "상황별 방책 선정 기준"

**수정 대상 파일**:
- `core_pipeline/ontology_generator.py`: 적용조건 필드 처리 로직 수정
- `metadata/schema_registry.yaml`: 적용조건 필드 타입을 `expression` → `list` 변경
- `knowledge/ontology/instances.ttl`: 기존 적용조건 값 마이그레이션

### 3.2 전장환경 조건 하드코딩
**현재 상태**: ⚠️ 중복
- 온톨로지에 `전장환경_최적조건`, `환경호환성`, `환경비호환성` 필드 (서술형)
- 예: `"주/야간, 가시거리>5km, 개활지형"`

**개선 방향**:
- ✅ **구조화 유지**: 환경 조건은 정량적 평가에 필요하므로 구조화 유지
- ✅ **설명 → RAG로 이동**: 조건 해석 기준은 RAG 문서로 처리

**수정 대상 파일**:
- 온톨로지 인스턴스: 환경 조건 필드 유지 (정량 평가용)
- RAG 문서 추가: "환경 조건 해석 가이드"

### 3.3 방책 유형별 특성 하드코딩
**현재 상태**: ⚠️ 부분 중복
- 온톨로지 스키마에 COA 타입별 속성 정의 (`defenseStrength`, `attackPower` 등)
- 실제 인스턴스에는 값이 없음 (대부분)

**개선 방향**:
- ✅ **스키마 유지**: 타입별 속성은 구조화 유지 (향후 확장 가능)
- ✅ **인스턴스 값 → RAG로 이동**: 특성 설명은 RAG 문서로 처리

### 3.4 적대응전술 하드코딩
**현재 상태**: ⚠️ 중복
- 온톨로지 인스턴스에 `적대응전술` 필드 (list 타입)
- 예: `["공중지원", "기갑 돌파", "포병 대화력전"]`
- 온톨로지에 하드코딩되어 있으나, 설명이 부족함

**개선 방향**:
- ✅ **RAG로 이동**: 적대응전술 설명 및 대응 방안은 RAG 문서로 처리
- ✅ **온톨로지 단순화**: 키워드만 유지 (선택적) 또는 완전 제거
- ✅ **RAG 문서 추가**: "적 대응전술 분석 가이드", "COA별 예상 적 대응 및 대응 방안"

**수정 대상 파일**:
- `core_pipeline/ontology_generator.py`: 적대응전술 필드 처리 로직 제거 또는 단순화
- `metadata/schema_registry.yaml`: 적대응전술 필드 제거 또는 선택적 필드로 변경

### 3.5 연계방책 하드코딩
**현재 상태**: ⚠️ 부분 중복
- 온톨로지에 `hasRelatedCOA` 관계 (구조화) ✅ 유지 필요
- `연계방책` 필드 (list 타입, 서술형) ⚠️ 중복
- 예: `"COA_DEF_001(선행), COA_DEF_003(후행)"`

**개선 방향**:
- ✅ **구조화 관계 유지**: `hasRelatedCOA` 관계는 유지 (SPARQL 질의에 필요)
- ✅ **서술형 필드 제거**: `연계방책` 필드 삭제
- ✅ **설명 → RAG로 이동**: 연계 방책 선택 기준은 RAG 문서로 처리
- ✅ **RAG 문서 추가**: "방책 연계 원칙", "선행/후행 방책 선정 기준"

**수정 대상 파일**:
- `metadata/schema_registry.yaml`: `연계방책` 필드 제거
- `core_pipeline/ontology_generator.py`: `연계방책` 필드 처리 로직 제거
- `knowledge/ontology/instances.ttl`: 기존 연계방책 값 제거 (hasRelatedCOA 관계는 유지)

### 3.6 규칙 엔진 중복
**현재 상태**: ⚠️ 확인 필요
- `agents/defense_coa_agent/rule_engine.py`: 규칙 엔진 존재
- 온톨로지 추론 규칙 (SWRL) 존재

**개선 방향**:
- ⚠️ **분석 필요**: 규칙 엔진과 온톨로지 추론의 역할 분리 확인
- ✅ **원칙**: 강제 제약 → 구조화, 판단 기준 → RAG

---

## 4. RAG 지식 증강(가상 교리 생성) 적용 방안

### 4.1 현재 RAG 문서 현황
**확인 완료**:
- RAG 문서 디렉토리: `knowledge/rag_docs/`
- 현재 문서 수: **3개**
  1. `작전_방책선정_지침.txt` - 방책 선정 절차 및 기준
  2. `ROE_및_제약조건.txt` - ROE 및 제약조건 설명
  3. `통신_보급_체크리스트.txt` - 통신/보급 체크리스트

**현재 상태**:
- ✅ RAG 인덱스 자동 구축 기능 구현됨 (`orchestrator.py::_build_rag_index_if_needed`)
- ✅ RAG 검색 기능 구현됨 (`rag_manager.py::retrieve_with_context`)
- ⚠️ 문서 수가 적음 (3개) - 확장 필요

### 4.2 가상 교리 생성 파이프라인 설계

#### 4.2.1 입력 데이터 분석
**단계 1: 기존 RAG 문서 분석**
```python
# core_pipeline/rag_knowledge_augmenter.py (신규 생성)
class RAGKnowledgeAugmenter:
    """RAG 지식 증강기"""
    
    def analyze_existing_docs(self, rag_docs: List[str]) -> Dict:
        """
        기존 RAG 문서 분석
        - 주요 키워드 추출
        - 상황-방책 패턴 추출
        - 교리 문장 패턴 식별
        """
```

**단계 2: LLM 기반 가상 교리 생성**
```python
def generate_virtual_doctrine(
    self,
    situation_patterns: Dict,
    coa_patterns: Dict,
    llm_manager
) -> List[str]:
    """
    LLM을 활용한 가상 교리 문장 생성
    
    생성 패턴:
    - "○○ 상황에서는 △△ 방책이 일반적으로 고려됨"
    - "지형이 △△하고 적 전력이 ○○일 경우 방어 우선"
    - "자원 가용성이 낮을 때는 기동 방책을 우선 검토"
    """
```

#### 4.2.2 생성된 교리를 RAG 문서로 재저장
**단계 3: RAG 문서 재인덱싱**
```python
def augment_rag_index(
    self,
    virtual_doctrine: List[str],
    rag_manager: RAGManager
):
    """
    생성된 가상 교리를 RAG 인덱스에 추가
    - 청킹
    - 임베딩 생성
    - FAISS 인덱스 업데이트
    """
```

### 4.3 구현 계획

#### Phase 1: RAG 문서 분석 및 패턴 추출
**파일**: `core_pipeline/rag_knowledge_augmenter.py` (신규)
**기능**:
- 기존 RAG 문서에서 상황-방책 패턴 추출
- 키워드 빈도 분석
- 교리 문장 패턴 식별

#### Phase 2: LLM 기반 가상 교리 생성
**파일**: `core_pipeline/rag_knowledge_augmenter.py` (확장)
**기능**:
- LLM 프롬프트 템플릿 설계
- 상황별 가상 교리 문장 생성
- 품질 검증 (중복 제거, 일관성 검사)

#### Phase 3: RAG 인덱스 자동 업데이트
**파일**: `core_pipeline/rag_manager.py` (확장)
**기능**:
- 신규 문서 자동 청킹
- 임베딩 생성 및 인덱스 업데이트
- 메타데이터 관리

#### Phase 4: 선순환 구조 구축
**파일**: `ui/views/rag_indexing.py` (확장)
**기능**:
- 가상 교리 생성 UI 추가
- 생성된 교리 검토 및 승인 워크플로우
- 자동 인덱싱 트리거

### 4.4 프롬프트 템플릿 설계

```python
VIRTUAL_DOCTRINE_PROMPT_TEMPLATE = """
다음은 기존 작전 지침 및 방책 선정 사례입니다.

기존 문서:
{existing_docs}

상황 패턴:
{situation_patterns}

방책 패턴:
{coa_patterns}

위 정보를 바탕으로 다음 형식의 가상 교리 문장을 생성해주세요:

1. "○○ 상황에서는 △△ 방책이 일반적으로 고려됨"
2. "지형이 △△하고 적 전력이 ○○일 경우 방어 우선"
3. "자원 가용성이 낮을 때는 기동 방책을 우선 검토"

각 문장은 간결하고 명확해야 하며, 실제 군사 교리와 유사한 톤을 유지해야 합니다.
"""
```

---

## 5. COA 추천 Agent 기준 최종 아키텍처 요약

### 5.1 역할 분리 원칙

#### SPARQL (온톨로지 기반)
**담당 영역**:
- ✅ 전장 데이터 검색 (부대, 위협, 지형 등)
- ✅ COA 라이브러리 검색 및 필터링
- ✅ 관계 추론 (체인 탐색)
- ✅ 제약 조건 검증
- ✅ 자원 가용성 조회

**구현 위치**:
- `core_pipeline/ontology_manager_enhanced.py`
- `core_pipeline/reasoning_engine.py`

#### LLM + RAG (교리·교범 기반)
**담당 영역**:
- ✅ 교리·교범 검색 및 참조
- ✅ 작전 절차 설명
- ✅ 서술형 판단 기준 제공
- ✅ 방책 선정 근거 생성
- ✅ 가상 교리 생성

**구현 위치**:
- `core_pipeline/rag_manager.py`
- `core_pipeline/coa_engine/llm_services.py::DoctrineSearchService`
- `core_pipeline/llm_manager.py`

#### 구조화 로직 (정량 평가)
**담당 영역**:
- ✅ METT-C 점수 계산
- ✅ COA 종합 점수 계산
- ✅ 자원 매칭률 계산
- ✅ 환경 적합성 평가
- ✅ 제약 조건 검증

**구현 위치**:
- `core_pipeline/mett_c_evaluator.py`
- `core_pipeline/coa_scorer.py`
- `core_pipeline/reasoning_engine.py`

### 5.2 COA 추천 프로세스 (개선 후)

```
1. 상황 입력
   ↓
2. SPARQL 검색 (전장 데이터, COA 후보)
   ↓
3. RAG 검색 (교리·교범 참조)
   ↓
4. 구조화 로직 평가 (METT-C, 점수 계산)
   ↓
5. LLM + RAG 기반 근거 생성
   ↓
6. 최종 추천 결과 반환
```

### 5.3 데이터 흐름

```
[Excel/DB] → [온톨로지] → [SPARQL 검색]
                              ↓
[RAG 문서] → [벡터 DB] → [RAG 검색] → [LLM]
                              ↓
[구조화 로직] → [점수 계산] → [최종 추천]
```

### 5.4 개선 우선순위

#### 우선순위 1: 중복 제거 (즉시)
1. ✅ `적용조건` 필드 단순화 (키워드만 유지)
2. ✅ `적대응전술` 필드 제거 또는 RAG로 이동
3. ✅ `연계방책` 서술형 필드 제거 (구조화 관계만 유지)

#### 우선순위 2: RAG 문서 확장 (단기)
1. ✅ 교리·교범 문서 추가
2. ✅ 작전 절차 설명 문서 추가
3. ✅ 판단 기준 가이드 문서 추가

#### 우선순위 3: 가상 교리 생성 (중기)
1. ✅ RAG 문서 분석 파이프라인 구현
2. ✅ LLM 기반 가상 교리 생성 구현
3. ✅ 자동 인덱싱 파이프라인 구현

#### 우선순위 4: 추가 기능 (장기)
1. ⚠️ 지휘관 의도 기반 가중치 조정
2. ⚠️ 지휘통제 구조 (OPCON/TACON/ADCON)
3. ⚠️ 인접 부대 충돌 감지

---

## 6. 구현 체크리스트

### 6.1 즉시 실행 가능 항목
- [x] RAG 문서 디렉토리 확인 및 문서 목록 정리 (완료: 3개 문서 확인)
- [ ] `적용조건` 필드 단순화 (expression → list, 키워드만 유지)
- [ ] `적대응전술` 필드 제거 또는 RAG로 이동
- [ ] `연계방책` 서술형 필드 제거 (hasRelatedCOA 관계는 유지)
- [ ] RAG 문서 추가 (최소 5개 추가 목표)

### 6.2 단기 구현 항목 (1-2주)
- [ ] 교리·교범 RAG 문서 추가 (최소 5개 문서)
- [ ] 작전 절차 설명 문서 추가
- [ ] 판단 기준 가이드 문서 추가
- [ ] RAG 인덱스 재구축

### 6.3 중기 구현 항목 (1개월)
- [ ] `RAGKnowledgeAugmenter` 클래스 구현
- [ ] LLM 기반 가상 교리 생성 파이프라인 구현
- [ ] 자동 인덱싱 워크플로우 구현
- [ ] UI 통합 (가상 교리 생성 탭)

### 6.4 장기 구현 항목 (향후)
- [ ] 지휘관 의도 기반 가중치 조정 로직
- [ ] 지휘통제 구조 온톨로지 확장
- [ ] 인접 부대 충돌 감지 로직

---

## 7. 예상 효과

### 7.1 정확도 향상
- 교리·교범 지식의 체계적 활용
- 가상 교리 생성으로 지식 확장

### 7.2 설명가능성 향상
- RAG 기반 근거 제공
- 교리 참조 링크 제공

### 7.3 확장성 향상
- 교리 문서 추가만으로 지식 확장
- 온톨로지 과도한 모델링 방지

### 7.4 유지보수성 향상
- 역할 분리 명확화
- 중복 제거로 코드 단순화

---

## 8. 참고 사항

### 8.1 현재 RAG 문서 확인 필요
- RAG 문서 디렉토리 위치 확인
- 현재 문서 수 및 내용 확인
- 인덱싱 상태 확인

### 8.2 온톨로지 스키마 검토 필요
- 교리 관련 속성 식별
- 중복 속성 제거 계획 수립

### 8.3 성능 고려사항
- RAG 검색 성능 최적화
- LLM 호출 빈도 최소화
- 캐싱 전략 수립

---

**작성자**: AI Assistant  
**검토 필요**: 시스템 아키텍트, 도메인 전문가

