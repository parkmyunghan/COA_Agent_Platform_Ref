"""
ëˆ„ë½ëœ ë°©ì±… ë°ì´í„° ì£¼ì… ìŠ¤í¬ë¦½íŠ¸
ì „ì²´ ìœ„í˜‘ ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ì—ì„œ ì‹ë³„ëœ ë¯¸ëŒ€ì‘ ìœ„í˜‘ ìœ í˜•ì— ëŒ€í•œ ë°©ì±…ì„ COA_Library.xlsxì— ì¶”ê°€í•©ë‹ˆë‹¤.
"""
import pandas as pd
from pathlib import Path
import sys

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ ê²½ë¡œ ì„¤ì •
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

def inject_missing_coas():
    file_path = project_root / "data_lake" / "COA_Library.xlsx"
    print(f"ğŸ“– Loading {file_path}...")
    
    df = pd.read_excel(file_path)
    
    # ì¶”ê°€í•  ë°©ì±… ëª©ë¡
    new_coas = [
        # 1. ì •ë©´ê³µê²© (Total War ê¸°ì¡´ ë°©ì±…ì— ë§¤í•‘) -> ê¸°ì¡´ í–‰ ì—…ë°ì´íŠ¸ í•„ìš”
        #    (ì´ ìŠ¤í¬ë¦½íŠ¸ì—ì„œëŠ” ë³„ë„ ì—…ë°ì´íŠ¸ ë¡œì§ êµ¬í˜„)
        
        # 2. ì§‘ê²°ì§•í›„ ëŒ€ì‘
        {
            "COA_ID": "COA_PRE_001",
            "ëª…ì¹­": "ì„ ì œ í¬ê²© ë° ê°ì‹œ ê°•í™”",
            "ë°©ì±…ìœ í˜•": "Preemptive",
            "ì„¤ëª…": "ì  ì§‘ê²° ì§•í›„ ì‹ë³„ ì§€ì—­ì— ëŒ€í•´ ê°ì‹œ ìì‚°ì„ ì§‘ì¤‘ ìš´ìš©í•˜ê³ , íƒ€ê²© ê°€ëŠ¥í•œ í¬ë³‘ í™”ë ¥ì„ ë¯¸ë¦¬ ì¡°ì¤€í•˜ì—¬ ìœ„í˜‘ êµ¬ì²´í™” ì‹œ ì¦‰ê° íƒ€ê²©.",
            "ì ìš©ì¡°ê±´": "threat_type == 'Assembly Signs' or threat_type == 'ì§‘ê²°ì§•í›„'",
            "í‚¤ì›Œë“œ": "ì§‘ê²°ì§•í›„, ì„ ì œíƒ€ê²©, ê°ì‹œ",
            "í•„ìš”ìì›": "í¬ë³‘ì—¬ë‹¨, UAVì¤‘ëŒ€",
            "ì „ì¥í™˜ê²½_ì œì•½": "ì•…ì²œí›„ ì‹œ í•­ê³µìì‚° ì œí•œ",
            "ì›Œê²Œì„_ëª¨ì˜_ë¶„ì„_ìŠ¹ë¥ ": 0.75,
            "ì í•©ìœ„í˜‘ìœ í˜•": "ì§‘ê²°ì§•í›„, ì  ì§‘ê²°",
            "ìì›ìš°ì„ ìˆœìœ„": "UAVì¤‘ëŒ€(í•„ìˆ˜), í¬ë³‘ì—¬ë‹¨(ê¶Œì¥)",
            "ì‹œê°í™”ìŠ¤íƒ€ì¼": "Recon_Target"
        },
        # 3. ì •ë°€íƒ€ê²© ëŒ€ì‘
        {
            "COA_ID": "COA_DEF_DISP_01", 
            "ëª…ì¹­": "ì£¼ìš” ìì‚° ë¶„ì‚° ë° ê¸°ë§Œ",
            "ë°©ì±…ìœ í˜•": "Defense",
            "ì„¤ëª…": "ì  ì •ë°€ íƒ€ê²© ì˜ˆìƒ ì‹œ, ì£¼ìš” ì§€íœ˜ì†Œ ë° í¬ë³‘ ìì‚°ì„ ë¶„ì‚° ë°°ì¹˜í•˜ê³  ê¸°ë§Œ ëª¨ì˜ ì¥ë¹„ë¥¼ ì„¤ì¹˜í•˜ì—¬ ìƒì¡´ì„±ì„ ë³´ì¥.",
            "ì ìš©ì¡°ê±´": "threat_type == 'Precision Strike'",
            "í‚¤ì›Œë“œ": "ì •ë°€íƒ€ê²©, ë¶„ì‚°, ê¸°ë§Œ",
            "í•„ìš”ìì›": "ê³µë³‘ëŒ€ëŒ€, í†µì‹ ëŒ€ëŒ€", # ê¸°ë§Œê¸° ì„¤ì¹˜ ë° í†µì‹ ë§ ë¶„ì‚°
            "ì „ì¥í™˜ê²½_ì œì•½": "ì—†ìŒ",
            "ì›Œê²Œì„_ëª¨ì˜_ë¶„ì„_ìŠ¹ë¥ ": 0.80,
            "ì í•©ìœ„í˜‘ìœ í˜•": "ì •ë°€íƒ€ê²©, ë¯¸ì‚¬ì¼ ê³µê²©",
            "ìì›ìš°ì„ ìˆœìœ„": "ê³µë³‘ëŒ€ëŒ€(ê¶Œì¥)",
            "ì‹œê°í™”ìŠ¤íƒ€ì¼": "Dispersal"
        },
        # 4. ê³µì¤‘ìœ„í˜‘ ëŒ€ì‘
        {
            "COA_ID": "COA_DEF_AIR_01",
            "ëª…ì¹­": "í†µí•© ë°©ê³µë§ ê°€ë™",
            "ë°©ì±…ìœ í˜•": "Defense",
            "ì„¤ëª…": "ì  í•­ê³µê¸° ë° ë“œë¡  ìœ„í˜‘ì— ëŒ€ì‘í•˜ì—¬ ë‹¨ê±°ë¦¬/ì¤‘ê±°ë¦¬ ë°©ê³µ ìì‚°ì„ í†µí•© ìš´ìš©í•˜ê³  ëŒ€ê³µ ê²½ê³„íƒœì„¸ë¥¼ ê²©ìƒ.",
            "ì ìš©ì¡°ê±´": "threat_type == 'Air Threat'",
            "í‚¤ì›Œë“œ": "ê³µì¤‘ìœ„í˜‘, ë°©ê³µ, ëŒ€ê³µ",
            "í•„ìš”ìì›": "ë°©ê³µëŒ€ëŒ€, íœ´ëŒ€ìš©ëŒ€ê³µë¯¸ì‚¬ì¼ë°˜",
            "ì „ì¥í™˜ê²½_ì œì•½": "ì‚°ì•… ì§€í˜• ì‹œ ë ˆì´ë” ì‚¬ê°",
            "ì›Œê²Œì„_ëª¨ì˜_ë¶„ì„_ìŠ¹ë¥ ": 0.70,
            "ì í•©ìœ„í˜‘ìœ í˜•": "ê³µì¤‘ìœ„í˜‘, í•­ê³µê¸° ê³µê²©",
            "ìì›ìš°ì„ ìˆœìœ„": "ë°©ê³µëŒ€ëŒ€(í•„ìˆ˜)",
            "ì‹œê°í™”ìŠ¤íƒ€ì¼": "Air_Defense"
        },
        # 5. í™”ìƒë°©ê³µê²© (ê¸°ë§Œì§•í›„ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ì§€ë§Œ í™”ìƒë°©ìœ¼ë¡œ ë¶„ë¥˜ë¨, ë‘˜ ë‹¤ ì»¤ë²„) ëŒ€ì‘
        {
            "COA_ID": "COA_DEF_CBRN_01",
            "ëª…ì¹­": "í™”ìƒë°© ì •ì°° ë° ì œë… ì‘ì „",
            "ë°©ì±…ìœ í˜•": "Defense",
            "ì„¤ëª…": "í™”ìƒë°© ì˜¤ì—¼ ì˜ì‹¬ ì§€ì—­ì— ì •ì°°ì°¨ëŸ‰ì„ íˆ¬ì…í•˜ì—¬ ì˜¤ì—¼ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê³ , ì œë…ì†Œë¥¼ ìš´ìš©í•˜ì—¬ ì „íˆ¬ë ¥ ë³´ì¡´.",
            "ì ìš©ì¡°ê±´": "threat_type == 'CBRN'",
            "í‚¤ì›Œë“œ": "í™”ìƒë°©, ì œë…, ì˜¤ì—¼",
            "í•„ìš”ìì›": "í™”ìƒë°©ëŒ€ëŒ€",
            "ì „ì¥í™˜ê²½_ì œì•½": "í’í–¥/í’ì† ì˜í–¥",
            "ì›Œê²Œì„_ëª¨ì˜_ë¶„ì„_ìŠ¹ë¥ ": 0.90,
            "ì í•©ìœ„í˜‘ìœ í˜•": "í™”ìƒë°©ê³µê²©, í™”í•™íƒ„, ìƒë¬¼í•™ë¬´ê¸°",
            "ìì›ìš°ì„ ìˆœìœ„": "í™”ìƒë°©ëŒ€ëŒ€(í•„ìˆ˜)",
            "ì‹œê°í™”ìŠ¤íƒ€ì¼": "CBRN_Ops"
        }
    ]
    
    # Dictionary í˜•íƒœ ë³´ì • (ìœ„ ë¦¬ìŠ¤íŠ¸ ì„ ì–¸ ì‹œ í‚¤:ê°’ ì‹¤ìˆ˜ ë°©ì§€ìš© ëª…ì‹œì  ì¬ì •ì˜)
    dict_coas = [
        {
            "COA_ID": "COA_PRE_001",
            "ëª…ì¹­": "ì„ ì œ í¬ê²© ë° ê°ì‹œ ê°•í™”",
            "ë°©ì±…ìœ í˜•": "Preemptive",
            "ì„¤ëª…": "ì  ì§‘ê²° ì§•í›„ ì‹ë³„ ì§€ì—­ì— ëŒ€í•´ ê°ì‹œ ìì‚°ì„ ì§‘ì¤‘ ìš´ìš©í•˜ê³ , íƒ€ê²© ê°€ëŠ¥í•œ í¬ë³‘ í™”ë ¥ì„ ë¯¸ë¦¬ ì¡°ì¤€í•˜ì—¬ ìœ„í˜‘ êµ¬ì²´í™” ì‹œ ì¦‰ê° íƒ€ê²©.",
            "ì í•©ìœ„í˜‘ìœ í˜•": "ì§‘ê²°ì§•í›„, ì  ì§‘ê²°",
            "í•„ìš”ìì›": "í¬ë³‘ì—¬ë‹¨, UAVì¤‘ëŒ€",
            "ì›Œê²Œì„_ëª¨ì˜_ë¶„ì„_ìŠ¹ë¥ ": 0.75
        },
        {
            "COA_ID": "COA_DEF_DISP_01",
            "ëª…ì¹­": "ì£¼ìš” ìì‚° ë¶„ì‚° ë° ê¸°ë§Œ",
            "ë°©ì±…ìœ í˜•": "Defense",
            "ì„¤ëª…": "ì  ì •ë°€ íƒ€ê²© ì˜ˆìƒ ì‹œ, ì£¼ìš” ì§€íœ˜ì†Œ ë° í¬ë³‘ ìì‚°ì„ ë¶„ì‚° ë°°ì¹˜í•˜ê³  ê¸°ë§Œ ëª¨ì˜ ì¥ë¹„ë¥¼ ì„¤ì¹˜í•˜ì—¬ ìƒì¡´ì„±ì„ ë³´ì¥.",
            "ì í•©ìœ„í˜‘ìœ í˜•": "ì •ë°€íƒ€ê²©, ë¯¸ì‚¬ì¼ ê³µê²©",
            "í•„ìš”ìì›": "ê³µë³‘ëŒ€ëŒ€, í†µì‹ ëŒ€ëŒ€",
            "ì›Œê²Œì„_ëª¨ì˜_ë¶„ì„_ìŠ¹ë¥ ": 0.82
        },
        {
            "COA_ID": "COA_DEF_AIR_01",
            "ëª…ì¹­": "í†µí•© ë°©ê³µë§ ê°€ë™",
            "ë°©ì±…ìœ í˜•": "Defense",
            "ì„¤ëª…": "ì  í•­ê³µê¸° ë° ë“œë¡  ìœ„í˜‘ì— ëŒ€ì‘í•˜ì—¬ ë‹¨ê±°ë¦¬/ì¤‘ê±°ë¦¬ ë°©ê³µ ìì‚°ì„ í†µí•© ìš´ìš©í•˜ê³  ëŒ€ê³µ ê²½ê³„íƒœì„¸ë¥¼ ê²©ìƒ.",
            "ì í•©ìœ„í˜‘ìœ í˜•": "ê³µì¤‘ìœ„í˜‘, í•­ê³µê¸° ê³µê²©",
            "í•„ìš”ìì›": "ë°©ê³µëŒ€ëŒ€, íœ´ëŒ€ìš©ëŒ€ê³µë¯¸ì‚¬ì¼ë°˜",
            "ì›Œê²Œì„_ëª¨ì˜_ë¶„ì„_ìŠ¹ë¥ ": 0.72
        },
        {
            "COA_ID": "COA_DEF_CBRN_01",
            "ëª…ì¹­": "í™”ìƒë°© ì •ì°° ë° ì œë… ì‘ì „",
            "ë°©ì±…ìœ í˜•": "Defense",
            "ì„¤ëª…": "í™”ìƒë°© ì˜¤ì—¼ ì˜ì‹¬ ì§€ì—­ì— ì •ì°°ì°¨ëŸ‰ì„ íˆ¬ì…í•˜ì—¬ ì˜¤ì—¼ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê³ , ì œë…ì†Œë¥¼ ìš´ìš©í•˜ì—¬ ì „íˆ¬ë ¥ ë³´ì¡´.",
            "ì í•©ìœ„í˜‘ìœ í˜•": "í™”ìƒë°©ê³µê²©, í™”í•™íƒ„, ìƒë¬¼í•™ë¬´ê¸°",
            "í•„ìš”ìì›": "í™”ìƒë°©ëŒ€ëŒ€",
            "ì›Œê²Œì„_ëª¨ì˜_ë¶„ì„_ìŠ¹ë¥ ": 0.88
        }
    ]

    count_added = 0
    count_updated = 0
    for coa in dict_coas:
        coa_id = coa["COA_ID"]
        if coa_id in df["COA_ID"].values:
            print(f"ğŸ”„ Updating {coa_id} ({coa['ëª…ì¹­']})")
            idx = df[df["COA_ID"] == coa_id].index[0]
            for key, val in coa.items():
                df.at[idx, key] = val
            count_updated += 1
        else:
            print(f"â• Adding {coa_id} ({coa['ëª…ì¹­']})")
            df = pd.concat([df, pd.DataFrame([coa])], ignore_index=True)
            count_added += 1
            
    # 6. ì •ë©´ê³µê²© í‚¤ì›Œë“œ ì¶”ê°€ (COA_DEF_TW01)
    # ê¸°ì¡´ ê°’: "ì „ë©´ì „, ê¸°ê³„í™”ë¶€ëŒ€ ê³µê²©" -> "ì „ë©´ì „, ê¸°ê³„í™”ë¶€ëŒ€ ê³µê²©, ì •ë©´ê³µê²©"
    idx_tw = df[df["COA_ID"] == "COA_DEF_TW01"].index
    if not idx_tw.empty:
        current_val = str(df.loc[idx_tw[0], "ì í•©ìœ„í˜‘ìœ í˜•"])
        if "ì •ë©´ê³µê²©" not in current_val:
            new_val = current_val + ", ì •ë©´ê³µê²©"
            df.loc[idx_tw[0], "ì í•©ìœ„í˜‘ìœ í˜•"] = new_val
            print(f"ğŸ”„ Updated COA_DEF_TW01 threat types: {new_val}")
    
    print(f"ğŸ’¾ Saving to {file_path}...")
    df.to_excel(file_path, index=False)
    print(f"âœ… Done. Added {count_added}, Updated {count_updated} COAs.")

if __name__ == "__main__":
    inject_missing_coas()
