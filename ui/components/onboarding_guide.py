# ui/components/onboarding_guide.py
# -*- coding: utf-8 -*-
"""
초기 사용자 가이드 컴포넌트
파일럿 프로그램 사용 방법 안내
"""
import streamlit as st
from pathlib import Path


def render_onboarding_guide():
    """초기 사용자 가이드 렌더링"""
    if "onboarding_completed" not in st.session_state:
        st.info("""
        👋 **처음 사용하시나요?**
        
        이 시스템은 **국방 Vertical AI 파일럿 프로그램**으로, 방책 추천 에이전트를 제공합니다.
        """)
        
        # 빠른 시작 가이드
        with st.expander("빠른 시작 가이드", expanded=True):
            st.markdown("""
            **시작 방법을 선택하세요:**
            """)
            
            # 두 가지 경로 제공
            col1, col2 = st.columns(2)
            
            with col1:
                st.markdown("""
                ### 빠른 체험 (권장)
                
                시스템이 자동으로 초기화되므로 바로 사용할 수 있습니다:
                
                1. 좌측 사이드바에서 **"5단계: Agent 실행"** 페이지로 이동
                2. **"DefenseCOA Agent"** 선택
                3. **"데모 시나리오"** 선택 (입력 방식에서)
                4. 질문 입력 (예: "적군 침입에 대한 방책 추천해줘")
                5. 결과 확인 및 추천 근거 분석
                
                **소요 시간:** 약 2-3분
                **추천 대상:** 처음 사용하시는 분, 빠르게 시스템을 체험하고 싶은 분
                """)
            
            with col2:
                st.markdown("""
                ### 전체 파이프라인 (체계적)
                
                각 단계를 순서대로 진행하여 시스템을 완전히 이해합니다:
                
                1. **1단계: 데이터 관리** - 데이터 확인 및 편집
                2. **2단계: 온톨로지 생성** - RDF 그래프 생성
                3. **3단계: 지식그래프 조회** - 그래프 시각화 및 조회
                4. **4단계: RAG 인덱스 구성** - 문서 업로드 및 인덱스 구축
                5. **5단계: Agent 실행** - 방책 추천 실행
                6. **6단계: 성능 모니터링** - 시스템 상태 확인
                
                **소요 시간:** 약 10-15분
                **추천 대상:** 시스템 전체를 이해하고 싶은 분, 데이터를 직접 편집해야 하는 분
                """)
            
            st.info("""
            **팁:** 
            - 처음 사용하시면 **빠른 체험** 경로를 권장합니다.
            - 시스템은 자동으로 데이터를 로드하고 온톨로지 그래프를 구축하므로, 빠른 체험 경로로도 충분히 작동합니다.
            - 더 정확한 추천을 원하시면 전체 파이프라인을 순서대로 진행하세요.
            """)
        
        # 전체 파이프라인 설명
        with st.expander("전체 파이프라인 이해", expanded=False):
            st.markdown("""
            이 시스템은 **5단계 파이프라인**으로 구성되어 있습니다:
            
            **1단계: 데이터 관리**
            - 원천 데이터(Excel 파일) 확인 및 편집
            - 데이터 품질 검증
            - 위치: 좌측 사이드바 → "1단계: 데이터 관리"
            
            **2단계: 온톨로지 생성**
            - Excel 데이터를 RDF 그래프로 변환
            - 엔티티 간 관계 구축
            - 위치: 좌측 사이드바 → "2단계: 온톨로지 생성"
            
            **3단계: 지식그래프 조회**
            - 생성된 온톨로지 그래프 시각화
            - SPARQL 쿼리로 관계 조회
            - 위치: 좌측 사이드바 → "3단계: 지식그래프 조회"
            
            **4단계: RAG 인덱스 구성**
            - 문서 업로드 및 관리
            - 검색 인덱스 구축
            - 위치: 좌측 사이드바 → "4단계: RAG 인덱스 구성"
            
            **5단계: Agent 실행**
            - 방책 추천 에이전트 실행
            - 상황 입력 및 결과 확인
            - 위치: 좌측 사이드바 → "5단계: Agent 실행"
            
            **6단계: 성능 모니터링**
            - 시스템 성능 확인
            - 파이프라인 상태 모니터링
            - 위치: 좌측 사이드바 → "6단계: 성능 모니터링"
            """)
        
        # 주요 기능 설명
        with st.expander("주요 기능", expanded=False):
            st.markdown("""
            **1. 방책 추천 (COA Recommendation)**
            - 위협 상황에 대한 최적 방책 추천
            - 팔란티어 방식: 6개 요소 종합 점수 계산
            - 추천 근거 및 점수 breakdown 제공
            
            **2. 팔란티어 모드**
            - 위협 수준, 자원 가용성, 전력 능력, 환경 적합성, 과거 효과성, 연계성
            - 각 요소별 가중치 적용
            - 종합 점수 기반 방책 선택
            
            **3. 실시간 데이터 변경 감지**
            - Excel 파일 변경 자동 감지
            - 온톨로지 증분 업데이트
            - 추천 결과 자동 갱신
            
            **4. 추론 과정 시각화**
            - 각 단계별 추론 과정 표시
            - 점수 계산 상세 정보
            - 온톨로지 관계 설명
            """)
        
        # 사용 팁
        with st.expander("사용 팁", expanded=False):
            st.markdown("""
            **효과적인 사용 방법:**
            
            1. **데이터 준비**: 먼저 1단계에서 데이터를 확인하고 필요한 경우 편집하세요.
            
            2. **온톨로지 생성**: 2단계에서 그래프를 생성하면 더 정확한 추천이 가능합니다.
            
            3. **팔란티어 모드 활성화**: 더 정교한 추천을 원하면 팔란티어 모드를 켜세요.
            
            4. **추론 과정 확인**: 추천 결과의 "추론 과정 상세"를 확인하면 근거를 이해할 수 있습니다.
            
            5. **데모 시나리오 활용**: 처음 사용하시면 데모 시나리오로 시스템을 체험해보세요.
            """)
        
        # 확인 버튼
        col1, col2, col3 = st.columns([1, 1, 1])
        with col2:
            if st.button("가이드 확인 완료", type="primary", width='stretch'):
                st.session_state.onboarding_completed = True
                st.rerun()


def render_quick_start_button():
    """빠른 시작 버튼 렌더링"""
    if st.button("빠른 시작: Agent 실행 페이지로 이동", width='stretch'):
        # Streamlit 페이지 네비게이션은 직접 지원하지 않으므로 안내만 표시
        st.info("좌측 사이드바에서 '5단계: Agent 실행' 페이지를 선택하세요.")


def render_help_tooltip(context: str = ""):
    """도움말 툴팁 렌더링"""
    help_texts = {
        "situation_input": "상황 정보를 입력하거나 위협상황 테이블에서 선택할 수 있습니다.",
        "agent_selection": "COA 추천 Agent는 상황 분석 및 방책 추천을 제공합니다.",
        "palantir_mode": "팔란티어 모드는 6개 요소를 종합하여 더 정교한 추천을 제공합니다.",
        "reasoning_explanation": "추론 과정을 단계별로 확인하여 추천 근거를 이해할 수 있습니다."
    }
    
    help_text = help_texts.get(context, "도움말을 확인하세요.")
    st.caption(f"{help_text}")
