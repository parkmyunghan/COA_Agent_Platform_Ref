# ui/components/pilot_goals_tracker.py
# -*- coding: utf-8 -*-
"""
íŒŒì¼ëŸ¿ ëª©í‘œ ë‹¬ì„±ë„ ì¶”ì  ì»´í¬ë„ŒíŠ¸
íŒŒì¼ëŸ¿ í”„ë¡œê·¸ë¨ì˜ ëª©í‘œ ë‹¬ì„± ì—¬ë¶€ë¥¼ ì¶”ì í•˜ê³  í‘œì‹œ
"""
import streamlit as st
from typing import Dict, List
from datetime import datetime


# íŒŒì¼ëŸ¿ ëª©í‘œ ì •ì˜
PILOT_GOALS = [
    {
        "id": "goal_1",
        "ëª©í‘œ": "ë°©ì±… ì¶”ì²œ ì—ì´ì „íŠ¸ êµ¬í˜„",
        "ì„¤ëª…": "ìœ„í˜‘ ìƒí™©ì— ëŒ€í•œ ë°©ì±… ì¶”ì²œ ê¸°ëŠ¥ êµ¬í˜„",
        "ë‹¬ì„± ê¸°ì¤€": "EnhancedDefenseCOAAgentê°€ ì •ìƒ ì‘ë™í•˜ê³  ë°©ì±…ì„ ì¶”ì²œí•  ìˆ˜ ìˆìŒ",
        "ë‹¬ì„±ë„": 100,
        "ìƒíƒœ": "âœ… ì™„ë£Œ",
        "ì¦ê±°": [
            "EnhancedDefenseCOAAgent êµ¬í˜„ ì™„ë£Œ",
            "íŒ”ë€í‹°ì–´ ë°©ì‹ ì ìˆ˜ ê³„ì‚° êµ¬í˜„",
            "ì‹¤ì œ ë°ì´í„° ê¸°ë°˜ ì¶”ì²œ ê°€ëŠ¥"
        ],
        "ìš°ì„ ìˆœìœ„": "P0"
    },
    {
        "id": "goal_2",
        "ëª©í‘œ": "íŒ”ë€í‹°ì–´ ë°©ì‹ ì ìš©",
        "ì„¤ëª…": "6ê°œ ìš”ì†Œ ì¢…í•© ì ìˆ˜ ê³„ì‚° ë°©ì‹ êµ¬í˜„",
        "ë‹¬ì„± ê¸°ì¤€": "ìœ„í˜‘, ìì›, ìì‚°, í™˜ê²½, ê³¼ê±°, ì—°ê³„ 6ê°œ ìš”ì†Œ ì ìˆ˜ ê³„ì‚° ë° ê°€ì¤‘ì¹˜ ì ìš©",
        "ë‹¬ì„±ë„": 90,
        "ìƒíƒœ": "âš ï¸ ë¶€ë¶„ ì™„ë£Œ",
        "ì¦ê±°": [
            "6ìš”ì†Œ ì ìˆ˜ ê³„ì‚° êµ¬í˜„ ì™„ë£Œ",
            "ê°€ì¤‘ì¹˜ Excel íŒŒì¼ í†µí•© ì™„ë£Œ",
            "ì¼ë¶€ ê²€ì¦ ë° í…ŒìŠ¤íŠ¸ í•„ìš”"
        ],
        "ìš°ì„ ìˆœìœ„": "P0"
    },
    {
        "id": "goal_3",
        "ëª©í‘œ": "ì˜¨í†¨ë¡œì§€ ê¸°ë°˜ ì¶”ë¡ ",
        "ì„¤ëª…": "RDF ì˜¨í†¨ë¡œì§€ë¥¼ í™œìš©í•œ ì§€ì‹ ê·¸ë˜í”„ ê¸°ë°˜ ì¶”ë¡ ",
        "ë‹¬ì„± ê¸°ì¤€": "Excel ë°ì´í„°ë¥¼ RDF ê·¸ë˜í”„ë¡œ ë³€í™˜í•˜ê³  SPARQL ì¿¼ë¦¬ë¡œ ê´€ê³„ ì¡°íšŒ ê°€ëŠ¥",
        "ë‹¬ì„±ë„": 85,
        "ìƒíƒœ": "âš ï¸ ë¶€ë¶„ ì™„ë£Œ",
        "ì¦ê±°": [
            "ì˜¨í†¨ë¡œì§€ êµ¬ì¶• ê¸°ëŠ¥ êµ¬í˜„",
            "SPARQL ì¿¼ë¦¬ ì‹¤í–‰ ê°€ëŠ¥",
            "ê´€ê³„ ì²´ì¸ íƒìƒ‰ êµ¬í˜„",
            "ì¦ë¶„ ì—…ë°ì´íŠ¸ ê¸°ëŠ¥ êµ¬í˜„"
        ],
        "ìš°ì„ ìˆœìœ„": "P0"
    },
    {
        "id": "goal_4",
        "ëª©í‘œ": "ì‹¤ì „ ì ìš© ê°€ëŠ¥ì„± ê²€ì¦",
        "ì„¤ëª…": "ì‹¤ì œ ì „ì¥ ë°ì´í„°ì™€ ìœ ì‚¬í•œ í™˜ê²½ì—ì„œì˜ ì ìš© ê°€ëŠ¥ì„± ê²€ì¦",
        "ë‹¬ì„± ê¸°ì¤€": "ì‹¤ì œ ë°ì´í„° í…Œì´ë¸” ì—°ë™, ë°ëª¨ ì‹œë‚˜ë¦¬ì˜¤ ì œê³µ, ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ í†µê³¼",
        "ë‹¬ì„±ë„": 70,
        "ìƒíƒœ": "âš ï¸ ê°œì„  í•„ìš”",
        "ì¦ê±°": [
            "ì‹¤ì œ ë°ì´í„° ì—°ë™ ê¸°ëŠ¥ êµ¬í˜„",
            "ë°ëª¨ ì‹œë‚˜ë¦¬ì˜¤ ì œê³µ",
            "ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ ê¸°ëŠ¥ êµ¬í˜„",
            "ì‹¤ì „ ì›Œí¬í”Œë¡œìš° ê²€ì¦ í•„ìš”"
        ],
        "ìš°ì„ ìˆœìœ„": "P1"
    },
    {
        "id": "goal_5",
        "ëª©í‘œ": "ì‹œìŠ¤í…œ êµ¬í˜„ ë¡œì§ ì´í•´ë„ í–¥ìƒ",
        "ì„¤ëª…": "ì‚¬ìš©ìê°€ ì‹œìŠ¤í…œì˜ ì¶”ë¡  ê³¼ì •ì„ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ì‹œê°í™” ë° ì„¤ëª… ì œê³µ",
        "ë‹¬ì„± ê¸°ì¤€": "ì¶”ë¡  ê³¼ì • ì‹œê°í™”, ì˜¨í†¨ë¡œì§€ ê´€ê³„ ì„¤ëª…, ì‚¬ìš©ì ê°€ì´ë“œ ì œê³µ",
        "ë‹¬ì„±ë„": 80,
        "ìƒíƒœ": "âš ï¸ ë¶€ë¶„ ì™„ë£Œ",
        "ì¦ê±°": [
            "ì¶”ë¡  ê³¼ì • ì‹œê°í™” ì»´í¬ë„ŒíŠ¸ êµ¬í˜„",
            "ì´ˆê¸° ì‚¬ìš©ì ê°€ì´ë“œ ì œê³µ",
            "ì˜¨í†¨ë¡œì§€ ê´€ê³„ ì„¤ëª… ê¸°ëŠ¥ í•„ìš”"
        ],
        "ìš°ì„ ìˆœìœ„": "P1"
    },
    {
        "id": "goal_6",
        "ëª©í‘œ": "UI ê°€ë…ì„± ë° ì‚¬ìš©ì„± ê°œì„ ",
        "ì„¤ëª…": "íŒŒì¼ëŸ¿ í”„ë¡œê·¸ë¨ ëª©ì ì— ë§ëŠ” ì§ê´€ì ì´ê³  ì‚¬ìš©í•˜ê¸° ì‰¬ìš´ UI ì œê³µ",
        "ë‹¬ì„± ê¸°ì¤€": "ë‹¨ê³„ë³„ ê°€ì´ë“œ, ì‚¬ìš©ì ì¹œí™”ì  ë©”ì‹œì§€, ì—ëŸ¬ ì²˜ë¦¬ ê°œì„ ",
        "ë‹¬ì„±ë„": 75,
        "ìƒíƒœ": "âš ï¸ ê°œì„  í•„ìš”",
        "ì¦ê±°": [
            "ë‹¨ê³„ë³„ í˜ì´ì§€ êµ¬ì¡°",
            "ì‚¬ìš©ì ê°€ì´ë“œ êµ¬í˜„",
            "ì¶”ì²œ ê²°ê³¼ ì‚¬ìš©ì ì¹œí™”ì  í‘œì‹œ",
            "ì—ëŸ¬ ë©”ì‹œì§€ ê°œì„  í•„ìš”"
        ],
        "ìš°ì„ ìˆœìœ„": "P1"
    }
]


def render_pilot_goals_tracker():
    """íŒŒì¼ëŸ¿ ëª©í‘œ ë‹¬ì„±ë„ ì¶”ì  íŒ¨ë„ ë Œë”ë§"""
    st.subheader("ğŸ¯ íŒŒì¼ëŸ¿ ëª©í‘œ ë‹¬ì„±ë„")
    
    st.info("""
    ğŸ’¡ **íŒŒì¼ëŸ¿ í”„ë¡œê·¸ë¨ ëª©í‘œ:** êµ­ë°© Vertical AI íŒŒì¼ëŸ¿ í”„ë¡œê·¸ë¨ì˜ ëª©í‘œ ë‹¬ì„± ì—¬ë¶€ë¥¼ ì¶”ì í•©ë‹ˆë‹¤.
    """)
    
    # ì „ì²´ ë‹¬ì„±ë„ ìš”ì•½
    render_overall_progress()
    
    st.divider()
    
    # ê° ëª©í‘œë³„ ìƒì„¸ ì •ë³´
    render_goal_details()


def render_overall_progress():
    """ì „ì²´ ë‹¬ì„±ë„ ìš”ì•½ í‘œì‹œ"""
    total_goals = len(PILOT_GOALS)
    completed_goals = sum(1 for goal in PILOT_GOALS if goal["ë‹¬ì„±ë„"] >= 100)
    avg_completion = sum(goal["ë‹¬ì„±ë„"] for goal in PILOT_GOALS) / total_goals if total_goals > 0 else 0
    
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric("ì „ì²´ ëª©í‘œ", total_goals)
    with col2:
        st.metric("ì™„ë£Œ", completed_goals, delta=f"{completed_goals}/{total_goals}")
    with col3:
        st.metric("í‰ê·  ë‹¬ì„±ë„", f"{avg_completion:.1f}%")
    with col4:
        p0_goals = [g for g in PILOT_GOALS if g["ìš°ì„ ìˆœìœ„"] == "P0"]
        p0_completed = sum(1 for g in p0_goals if g["ë‹¬ì„±ë„"] >= 100)
        st.metric("P0 ì™„ë£Œ", f"{p0_completed}/{len(p0_goals)}")
    
    # ì „ì²´ ì§„í–‰ë¥  ë°”
    st.progress(avg_completion / 100)


def render_goal_details():
    """ê° ëª©í‘œë³„ ìƒì„¸ ì •ë³´ í‘œì‹œ"""
    st.markdown("#### ğŸ“‹ ëª©í‘œë³„ ìƒì„¸ ì •ë³´")
    
    # ìš°ì„ ìˆœìœ„ë³„ë¡œ ì •ë ¬
    sorted_goals = sorted(PILOT_GOALS, key=lambda x: (x["ìš°ì„ ìˆœìœ„"], -x["ë‹¬ì„±ë„"]))
    
    for goal in sorted_goals:
        with st.expander(
            f"{goal['ìƒíƒœ']} {goal['ëª©í‘œ']} (ë‹¬ì„±ë„: {goal['ë‹¬ì„±ë„']}%)",
            expanded=(goal['ë‹¬ì„±ë„'] < 100)
        ):
            # ëª©í‘œ ì •ë³´
            st.write(f"**ì„¤ëª…:** {goal['ì„¤ëª…']}")
            st.write(f"**ë‹¬ì„± ê¸°ì¤€:** {goal['ë‹¬ì„± ê¸°ì¤€']}")
            st.write(f"**ìš°ì„ ìˆœìœ„:** {goal['ìš°ì„ ìˆœìœ„']}")
            
            # ë‹¬ì„±ë„ ì§„í–‰ë¥ 
            st.progress(goal['ë‹¬ì„±ë„'] / 100)
            
            # ì¦ê±° ëª©ë¡
            st.markdown("**ì¦ê±°:**")
            for evidence in goal['ì¦ê±°']:
                st.write(f"- âœ… {evidence}")
            
            # ê°œì„  í•„ìš” ì‚¬í•­ (ë‹¬ì„±ë„ < 100ì¸ ê²½ìš°)
            if goal['ë‹¬ì„±ë„'] < 100:
                st.markdown("**ê°œì„  í•„ìš” ì‚¬í•­:**")
                improvement_suggestions = get_improvement_suggestions(goal['id'])
                for suggestion in improvement_suggestions:
                    st.write(f"- ğŸ’¡ {suggestion}")


def get_improvement_suggestions(goal_id: str) -> List[str]:
    """ëª©í‘œë³„ ê°œì„  ì œì•ˆ ë°˜í™˜"""
    suggestions_map = {
        "goal_2": [
            "SPARQL ì¿¼ë¦¬ ê²°ê³¼ ê²€ì¦ ê°•í™”",
            "ì ìˆ˜ ê³„ì‚° ë¡œì§ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì¶”ê°€",
            "ì‹¤ì œ ë°ì´í„° ê¸°ë°˜ í†µí•© í…ŒìŠ¤íŠ¸"
        ],
        "goal_3": [
            "ì˜¨í†¨ë¡œì§€ ê´€ê³„ ì„¤ëª… UI ì¶”ê°€",
            "SPARQL ì¿¼ë¦¬ ì„±ëŠ¥ ìµœì í™”",
            "ê´€ê³„ ì²´ì¸ íƒìƒ‰ ê²°ê³¼ ì‹œê°í™”"
        ],
        "goal_4": [
            "ì‹¤ì „ ì›Œí¬í”Œë¡œìš° ì‹œë®¬ë ˆì´ì…˜",
            "ì‹¤ì œ ì „ì¥ ë°ì´í„° ìƒ˜í”Œ í…ŒìŠ¤íŠ¸",
            "ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ ëª©í‘œ ë‹¬ì„±"
        ],
        "goal_5": [
            "ì˜¨í†¨ë¡œì§€ ê´€ê³„ ì„¤ëª… ì»´í¬ë„ŒíŠ¸ êµ¬í˜„",
            "ì¶”ë¡  ê³¼ì • ë‹¨ê³„ë³„ ìƒì„¸ ì„¤ëª… ì¶”ê°€",
            "ì‚¬ìš©ì ê°€ì´ë“œ ë³´ì™„"
        ],
        "goal_6": [
            "ì‚¬ìš©ì ì¹œí™”ì  ì—ëŸ¬ ë©”ì‹œì§€ êµ¬í˜„",
            "UI/UX ê°œì„  (íƒ­ ê¸°ë°˜ êµ¬ì¡° ë“±)",
            "ì ‘ê·¼ì„± í–¥ìƒ"
        ]
    }
    
    return suggestions_map.get(goal_id, [])


def update_goal_progress(goal_id: str, new_completion: int, new_evidence: List[str] = None):
    """
    ëª©í‘œ ë‹¬ì„±ë„ ì—…ë°ì´íŠ¸ (í–¥í›„ í™•ì¥ìš©)
    
    Args:
        goal_id: ëª©í‘œ ID
        new_completion: ìƒˆë¡œìš´ ë‹¬ì„±ë„ (0-100)
        new_evidence: ì¶”ê°€ ì¦ê±° ëª©ë¡
    """
    for goal in PILOT_GOALS:
        if goal["id"] == goal_id:
            goal["ë‹¬ì„±ë„"] = new_completion
            if new_completion >= 100:
                goal["ìƒíƒœ"] = "âœ… ì™„ë£Œ"
            elif new_completion >= 80:
                goal["ìƒíƒœ"] = "âš ï¸ ë¶€ë¶„ ì™„ë£Œ"
            else:
                goal["ìƒíƒœ"] = "âš ï¸ ê°œì„  í•„ìš”"
            
            if new_evidence:
                goal["ì¦ê±°"].extend(new_evidence)
            
            break


